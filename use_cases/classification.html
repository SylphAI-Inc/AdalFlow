<!doctype html>
<html class="no-js" lang="en" data-content_root="../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="RAG optimization" href="rag_opt.html" /><link rel="prev" title="Q&amp;A Few Shot Demo Trace Graph" href="qa_demo_trace_graph.html" />

    <link rel="shortcut icon" href="../_static/LightRAG-logo-circle.png"/><!-- Generated with Sphinx 7.4.7 and Furo 2024.08.06 -->
        <title>Classification Optimization - Build and Optimize LM Workflows</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom.css?v=f0068426" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../_static/css/rtd_sphinx_search.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?v=302659d7" />
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  --color-brand-primary: #FF6F00;
  --color-brand-content: #1E2A38;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-brand-primary: #FF8F00;
  --color-brand-content: #CFD8DC;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-brand-primary: #FF8F00;
  --color-brand-content: #CFD8DC;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">Build and Optimize LM Workflows</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo only-light" src="../_static/images/AdalFlow.svg" alt="Light Logo"/>
    <img class="sidebar-logo only-dark" src="../_static/images/AdalFlow_black_bg.svg" alt="Dark Logo"/>
  </div>
  
  <span class="sidebar-brand-text">Build and Optimize LM Workflows</span>
  
</a><div class="sidebar-github-section">
    <a href="https://github.com/SylphAI-Inc/AdalFlow" class="sidebar-github-link">
        <i class="fa-brands fa-github"></i>
        <span class="github-text">GitHub</span>
    </a>
</div><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Getting Started</a></li>
</ul>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../new_tutorials/index.html">Tutorials</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Tutorials</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../new_tutorials/core_concepts.html">Core Concepts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../new_tutorials/generator.html">Generator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../new_tutorials/embedder.html">Embedder</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/retriever.html">retriever</a></li>
<li class="toctree-l2"><a class="reference internal" href="../new_tutorials/tool.html">Tool Use</a></li>
<li class="toctree-l2"><a class="reference internal" href="../new_tutorials/agents_runner.html">Agent Runner</a></li>
<li class="toctree-l2"><a class="reference internal" href="../new_tutorials/streaming.html">Streaming</a></li>
<li class="toctree-l2"><a class="reference internal" href="../new_tutorials/tracing.html">Tracing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../new_tutorials/human_in_the_loop.html">Human in the Loop</a></li>
<li class="toctree-l2"><a class="reference internal" href="../new_tutorials/prompt.html">Prompt</a></li>
<li class="toctree-l2"><a class="reference internal" href="../new_tutorials/parser.html">Parser and Structured Output</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../integrations/index.html">Integrations</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Integrations</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../integrations/integrations.html">All Providers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../integrations/anthropic.html">Anthropic Integration</a></li>
</ul>
</li>
</ul>
<ul class="current">
<li class="toctree-l1 current has-children"><a class="reference internal" href="index.html">Use Cases</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of Use Cases</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="question_answering.html">Question Answering</a></li>
<li class="toctree-l2"><a class="reference internal" href="qa_computation_graph.html">Q&amp;A Computation Graph</a></li>
<li class="toctree-l2"><a class="reference internal" href="qa_text_grad_trace_graph.html">Q&amp;A Text Grad Trace Graph</a></li>
<li class="toctree-l2"><a class="reference internal" href="qa_demo_trace_graph.html">Q&amp;A Few Shot Demo Trace Graph</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Classification Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="rag_opt.html">RAG optimization</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../contributor/index.html">Contributor Guide</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of Contributor Guide</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../contributor/contribution.html">Contributing Process</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contributor/contribute_to_code.html">Development Essentials</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../tutorials/index.html">Developer Notes</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle navigation of Developer Notes</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/lightrag_design_philosophy.html">Design Philosophy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/class_hierarchy.html">Class Hierarchy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/trace_graph.html">AdalFlow Trace Graph</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/component.html">Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/base_data_class.html">DataClass</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/prompt.html">Prompt</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/model_client.html">ModelClient</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/generator.html">Generator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/generator.html#basic-generator-tutorial">Basic Generator Tutorial</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/output_parsers.html">Parser</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/embedder.html">Embedder</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/retriever.html">Retriever</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/text_splitter.html">Text Splitter</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/db.html">Data (Database/Pipeline)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/rag_playbook.html">RAG Playbook</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/rag_with_memory.html">RAG with Memory</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/tool_helper.html">Function calls</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/agent.html">ReAct Agent</a></li>
<li class="toctree-l2"><a class="reference internal" href="../new_tutorials/agents_runner.html">Agents and Runner</a></li>
<li class="toctree-l2"><a class="reference internal" href="../new_tutorials/streaming.html">Streaming</a></li>
<li class="toctree-l2"><a class="reference internal" href="../new_tutorials/tracing.html">Tracing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../new_tutorials/human_in_the_loop.html">Human in the Loop</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/evaluation.html">LLM Evaluation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/datasets.html">Datasets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/logging.html">Logger Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/logging.html#design">Design</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/logging.html#use-logger-in-projects">Use Logger in Projects</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/logging_tracing.html">Tracing</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../design/index.html">Blog</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle navigation of Blog</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../design/ComponentTool.html">Use Class method as a better function tool</a></li>
<li class="toctree-l2"><a class="reference internal" href="../design/FunctionTool.html">Designing of AdalFlow FunctionTool</a></li>
<li class="toctree-l2"><a class="reference internal" href="../design/agent-streaming.html">Agent Streaming Architecture in OpenAI Agents SDK</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../apis/index.html">API Reference</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><div class="visually-hidden">Toggle navigation of API Reference</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../apis/core/index.html">Core</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" role="switch" type="checkbox"/><label for="toctree-checkbox-8"><div class="visually-hidden">Toggle navigation of Core</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../apis/core/core.base_data_class.html">base_data_class</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apis/core/core.component.html">component</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apis/core/core.container.html">container</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apis/core/core.default_prompt_template.html">default_prompt_template</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apis/core/core.embedder.html">embedder</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apis/core/core.generator.html">generator</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apis/core/core.model_client.html">model_client</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apis/core/core.prompt_builder.html">prompt_builder</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apis/core/core.retriever.html">retriever</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apis/core/core.string_parser.html">string_parser</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apis/core/core.func_tool.html">func_tool</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apis/core/core.tool_manager.html">tool_manager</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apis/core/core.types.html">types</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apis/core/core.db.html">db</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apis/core/core.functional.html">functional</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apis/core/core.tokenizer.html">tokenizer</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../apis/components/index.html">Components</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" role="switch" type="checkbox"/><label for="toctree-checkbox-9"><div class="visually-hidden">Toggle navigation of Components</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3 has-children"><a class="reference internal" href="../apis/components/components.model_client.html">model_client</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" role="switch" type="checkbox"/><label for="toctree-checkbox-10"><div class="visually-hidden">Toggle navigation of model_client</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../apis/components/components.model_client.anthropic_client.html">anthropic_client</a></li>
<li class="toctree-l4"><a class="reference internal" href="../apis/components/components.model_client.azureai_client.html">azureai_client</a></li>
<li class="toctree-l4"><a class="reference internal" href="../apis/components/components.model_client.bedrock_client.html">bedrock_client</a></li>
<li class="toctree-l4"><a class="reference internal" href="../apis/components/components.model_client.chat_completion_to_response_converter.html">chat_completion_to_response_converter</a></li>
<li class="toctree-l4"><a class="reference internal" href="../apis/components/components.model_client.cohere_client.html">cohere_client</a></li>
<li class="toctree-l4"><a class="reference internal" href="../apis/components/components.model_client.deepseek_client.html">deepseek_client</a></li>
<li class="toctree-l4"><a class="reference internal" href="../apis/components/components.model_client.fireworks_client.html">fireworks_client</a></li>
<li class="toctree-l4"><a class="reference internal" href="../apis/components/components.model_client.google_client.html">google_client</a></li>
<li class="toctree-l4"><a class="reference internal" href="../apis/components/components.model_client.groq_client.html">groq_client</a></li>
<li class="toctree-l4"><a class="reference internal" href="../apis/components/components.model_client.mistral_client.html">mistral_client</a></li>
<li class="toctree-l4"><a class="reference internal" href="../apis/components/components.model_client.ollama_client.html">ollama_client</a></li>
<li class="toctree-l4"><a class="reference internal" href="../apis/components/components.model_client.openai_client.html">openai_client</a></li>
<li class="toctree-l4"><a class="reference internal" href="../apis/components/components.model_client.sambanova_client.html">sambanova_client</a></li>
<li class="toctree-l4"><a class="reference internal" href="../apis/components/components.model_client.together_client.html">together_client</a></li>
<li class="toctree-l4"><a class="reference internal" href="../apis/components/components.model_client.transformers_client.html">transformers_client</a></li>
<li class="toctree-l4"><a class="reference internal" href="../apis/components/components.model_client.utils.html">utils</a></li>
<li class="toctree-l4"><a class="reference internal" href="../apis/components/components.model_client.xai_client.html">xai_client</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../apis/components/components.retriever.html">retriever</a><input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" role="switch" type="checkbox"/><label for="toctree-checkbox-11"><div class="visually-hidden">Toggle navigation of retriever</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../apis/components/components.retriever.bm25_retriever.html">bm25_retriever</a></li>
<li class="toctree-l4"><a class="reference internal" href="../apis/components/components.retriever.faiss_retriever.html">faiss_retriever</a></li>
<li class="toctree-l4"><a class="reference internal" href="../apis/components/components.retriever.lancedb_retriver.html">lancedb_retriver</a></li>
<li class="toctree-l4"><a class="reference internal" href="../apis/components/components.retriever.llm_retriever.html">llm_retriever</a></li>
<li class="toctree-l4"><a class="reference internal" href="../apis/components/components.retriever.postgres_retriever.html">postgres_retriever</a></li>
<li class="toctree-l4"><a class="reference internal" href="../apis/components/components.retriever.qdrant_retriever.html">qdrant_retriever</a></li>
<li class="toctree-l4"><a class="reference internal" href="../apis/components/components.retriever.reranker_retriever.html">reranker_retriever</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../apis/components/components.output_parsers.html">output_parsers</a><input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" role="switch" type="checkbox"/><label for="toctree-checkbox-12"><div class="visually-hidden">Toggle navigation of output_parsers</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../apis/components/components.output_parsers.dataclass_parser.html">dataclass_parser</a></li>
<li class="toctree-l4"><a class="reference internal" href="../apis/components/components.output_parsers.outputs.html">outputs</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../apis/components/components.agent.html">agent</a><input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" role="switch" type="checkbox"/><label for="toctree-checkbox-13"><div class="visually-hidden">Toggle navigation of agent</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../apis/components/components.agent.agent.html">agent</a></li>
<li class="toctree-l4"><a class="reference internal" href="../apis/components/components.agent.prompts.html">prompts</a></li>
<li class="toctree-l4"><a class="reference internal" href="../apis/components/components.agent.react.html">react</a></li>
<li class="toctree-l4"><a class="reference internal" href="../apis/components/components.agent.runner.html">runner</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../apis/components/components.data_process.html">data_process</a><input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" role="switch" type="checkbox"/><label for="toctree-checkbox-14"><div class="visually-hidden">Toggle navigation of data_process</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../apis/components/components.data_process.data_components.html">data_components</a></li>
<li class="toctree-l4"><a class="reference internal" href="../apis/components/components.data_process.text_splitter.html">text_splitter</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../apis/components/components.memory.html">memory</a><input class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" role="switch" type="checkbox"/><label for="toctree-checkbox-15"><div class="visually-hidden">Toggle navigation of memory</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../apis/components/components.memory.memory.html">memory</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../apis/datasets/index.html">Datasets</a><input class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" role="switch" type="checkbox"/><label for="toctree-checkbox-16"><div class="visually-hidden">Toggle navigation of Datasets</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../apis/datasets/datasets.big_bench_hard.html">big_bench_hard</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apis/datasets/datasets.trec.html">trec</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apis/datasets/datasets.hotpot_qa.html">hotpot_qa</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apis/datasets/datasets.types.html">types</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../apis/eval/index.html">Evaluation</a><input class="toctree-checkbox" id="toctree-checkbox-17" name="toctree-checkbox-17" role="switch" type="checkbox"/><label for="toctree-checkbox-17"><div class="visually-hidden">Toggle navigation of Evaluation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../apis/eval/eval.base.html">base</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apis/eval/eval.answer_match_acc.html">answer_match_acc</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apis/eval/eval.retriever_recall.html">retriever_recall</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apis/eval/eval.llm_as_judge.html">llm_as_judge</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apis/eval/eval.g_eval.html">g_eval</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../apis/optim/index.html">Optimization</a><input class="toctree-checkbox" id="toctree-checkbox-18" name="toctree-checkbox-18" role="switch" type="checkbox"/><label for="toctree-checkbox-18"><div class="visually-hidden">Toggle navigation of Optimization</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../apis/optim/optim.parameter.html">parameter</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apis/optim/optim.optimizer.html">optimizer</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apis/optim/optim.grad_component.html">grad_component</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apis/optim/optim.loss_component.html">loss_component</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apis/optim/optim.types.html">types</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../apis/optim/optim.few_shot.html">few_shot</a><input class="toctree-checkbox" id="toctree-checkbox-19" name="toctree-checkbox-19" role="switch" type="checkbox"/><label for="toctree-checkbox-19"><div class="visually-hidden">Toggle navigation of few_shot</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../apis/optim/optim.few_shot.bootstrap_optimizer.html">bootstrap_optimizer</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../apis/optim/optim.text_grad.html">text_grad</a><input class="toctree-checkbox" id="toctree-checkbox-20" name="toctree-checkbox-20" role="switch" type="checkbox"/><label for="toctree-checkbox-20"><div class="visually-hidden">Toggle navigation of text_grad</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../apis/optim/optim.text_grad.backend_engine_prompt.html">backend_engine_prompt</a></li>
<li class="toctree-l4"><a class="reference internal" href="../apis/optim/optim.text_grad.llm_text_loss.html">llm_text_loss</a></li>
<li class="toctree-l4"><a class="reference internal" href="../apis/optim/optim.text_grad.ops.html">ops</a></li>
<li class="toctree-l4"><a class="reference internal" href="../apis/optim/optim.text_grad.text_loss_with_eval_fn.html">text_loss_with_eval_fn</a></li>
<li class="toctree-l4"><a class="reference internal" href="../apis/optim/optim.text_grad.tgd_optimizer.html">tgd_optimizer</a></li>
</ul>
</li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../apis/optim/optim.trainer.html">trainer</a><input class="toctree-checkbox" id="toctree-checkbox-21" name="toctree-checkbox-21" role="switch" type="checkbox"/><label for="toctree-checkbox-21"><div class="visually-hidden">Toggle navigation of trainer</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../apis/optim/optim.trainer.adal.html">adal</a></li>
<li class="toctree-l4"><a class="reference internal" href="../apis/optim/optim.trainer.trainer.html">trainer</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../apis/tracing/index.html">Tracing</a><input class="toctree-checkbox" id="toctree-checkbox-22" name="toctree-checkbox-22" role="switch" type="checkbox"/><label for="toctree-checkbox-22"><div class="visually-hidden">Toggle navigation of Tracing</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../apis/tracing/tracing.callback_manager.html">callback_manager</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apis/tracing/tracing.create.html">create</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apis/tracing/tracing.decorators.html">decorators</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apis/tracing/tracing.generator_call_logger.html">generator_call_logger</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apis/tracing/tracing.generator_state_logger.html">generator_state_logger</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apis/tracing/tracing.mlflow_integration.html">mlflow_integration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apis/tracing/tracing.processor_interface.html">processor_interface</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apis/tracing/tracing.scope.html">scope</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apis/tracing/tracing.setup.html">setup</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apis/tracing/tracing.span_data.html">span_data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apis/tracing/tracing.spans.html">spans</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apis/tracing/tracing.traces.html">traces</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apis/tracing/tracing.util.html">util</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../apis/utils/index.html">Utils</a><input class="toctree-checkbox" id="toctree-checkbox-23" name="toctree-checkbox-23" role="switch" type="checkbox"/><label for="toctree-checkbox-23"><div class="visually-hidden">Toggle navigation of Utils</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../apis/utils/utils.data.html">data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apis/utils/utils.setup_env.html">setup_env</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apis/utils/utils.logger.html">logger</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apis/utils/utils.file_io.html">file_io</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apis/utils/utils.config.html">config</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apis/utils/utils.lazy_import.html">lazy_import</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apis/utils/utils.registry.html">registry</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apis/utils/utils.serialization.html">serialization</a></li>
<li class="toctree-l3"><a class="reference internal" href="../apis/utils/utils.cache.html">cache</a></li>
</ul>
</li>
</ul>
</li>
</ul>

</div>
</div>
      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          

<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <div style="display: flex; justify-content: flex-start; align-items: center; margin-bottom: 20px;">
   <a href="https://colab.research.google.com/github/SylphAI-Inc/AdalFlow/blob/main/notebooks/tutorials/adalflow_classification_optimization.ipynb" target="_blank" style="margin-right: 20px;">
      <img alt="Open In Colab" src="https://colab.research.google.com/assets/colab-badge.svg" style="height: 20px;">
   </a>

   <a href="https://github.com/SylphAI-Inc/AdalFlow/tree/main/use_cases/classification" target="_blank" style="display: flex; align-items: center;">
      <img src="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" alt="GitHub" style="height: 20px; width: 20px; margin-right: 5px;">
      <span style="vertical-align: middle;"> Open Source Code</span>
   </a>
</div><section id="classification-optimization">
<span id="classification-end-to-end"></span><h1>Classification Optimization<a class="headerlink" href="#classification-optimization" title="Link to this heading">¶</a></h1>
<p>Classification is one of the most widely used tasks in NLP.
Optimizing GenAI-based classification can help developers quickly create a well-performing model.
In the long term, this model can also help bootstrap the training of a more cost-effective classification model.</p>
<figure class="align-center" id="id1">
<a class="reference internal image-reference" href="../_images/classification_training_map.png"><img alt="Learning Curve" src="../_images/classification_training_map.png" style="width: 700px;" />
</a>
<figcaption>
<p><span class="caption-text">Learning Curve on training system task instruction and on one-shot demonstration.</span><a class="headerlink" href="#id1" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<figure class="align-center" id="id2">
<a class="reference internal image-reference" href="../_images/classification_opt_prompt.png"><img alt="Optimized prompt" src="../_images/classification_opt_prompt.png" style="width: 700px;" />
</a>
<figcaption>
<p><span class="caption-text">The optimized prompt for the classification task.</span><a class="headerlink" href="#id2" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<p>Here is what you  will learn from this tutorial:</p>
<ol class="arabic simple">
<li><p>How to build a classification task pipeline with structured output.</p></li>
<li><p>The concepts of <code class="docutils literal notranslate"><span class="pre">mixed</span></code> and <code class="docutils literal notranslate"><span class="pre">sequential</span></code> training as we explore both <code class="docutils literal notranslate"><span class="pre">TextOptimizer</span></code> and <code class="docutils literal notranslate"><span class="pre">DemoOptimizer</span></code> to optimize the classification task.</p></li>
<li><p>How to handle the situations where the val dataset is not a good indicator of test accuracy.</p></li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You can find all our code in our GitHub repo: <cite>use_cases/classification</cite>, and the Dspy implementation at <cite>benchmarks/trec_classification</cite>.</p>
</div>
<section id="task-pipeline-with-structured-output">
<h2>Task Pipeline with Structured Output<a class="headerlink" href="#task-pipeline-with-structured-output" title="Link to this heading">¶</a></h2>
<p>We will use the following overall template with <code class="docutils literal notranslate"><span class="pre">system_prompt</span></code>, <code class="docutils literal notranslate"><span class="pre">output_format_str</span></code>, and <code class="docutils literal notranslate"><span class="pre">few_shot_demos</span></code> varaibles.
<code class="docutils literal notranslate"><span class="pre">task_desc_template</span></code> will be used to render the final classification task description from class names and each label’s description.
<code class="docutils literal notranslate"><span class="pre">TRECExtendedData</span></code> is a dataclass that extends <a class="reference internal" href="../apis/datasets/datasets.types.html#datasets.types.TrecData" title="datasets.types.TrecData"><code class="xref py py-class docutils literal notranslate"><span class="pre">TrecData</span></code></a> with a rationale field. This will ensure our generator to first levarage ‘Chain-of-Thought’ reasoning before predicting the final class_name.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">template</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;&lt;START_OF_SYSTEM_MESSAGE&gt;</span>
<span class="s2"> {{system_prompt}}</span>
<span class="s2"> {</span><span class="si">% i</span><span class="s2">f output_format_str is not none %}</span>
<span class="s2"> {{output_format_str}}</span>
<span class="s2"> {</span><span class="si">% e</span><span class="s2">ndif %}</span>
<span class="s2"> {</span><span class="si">% i</span><span class="s2">f few_shot_demos is not none %}</span>
<span class="s2"> Here are some examples:</span>
<span class="s2"> {{few_shot_demos}}</span>
<span class="s2"> {</span><span class="si">% e</span><span class="s2">ndif %}</span>
<span class="s2"> &lt;END_OF_SYSTEM_MESSAGE&gt;</span>
<span class="s2"> &lt;START_OF_USER_MESSAGE&gt;</span>
<span class="s2"> {{input_str}}</span>
<span class="s2"> &lt;END_OF_USER_MESSAGE&gt;</span>
<span class="s2"> &quot;&quot;&quot;</span>

 <span class="n">task_desc_template</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;&quot;&quot;You are a classifier. Given a question, you need to classify it into one of the following classes:</span>
<span class="s2"> Format: class_index. class_name, class_description</span>
<span class="s2"> {</span><span class="si">% i</span><span class="s2">f classes %}</span>
<span class="s2"> {</span><span class="si">% f</span><span class="s2">or class in classes %}</span>
<span class="s2"> {{loop.index-1}}. {{class.label}}, {{class.desc}}</span>
<span class="s2"> {</span><span class="si">% e</span><span class="s2">ndfor %}</span>
<span class="s2"> {</span><span class="si">% e</span><span class="s2">ndif %}</span>
<span class="s2"> - Do not try to answer the question:</span>
<span class="s2"> &quot;&quot;&quot;</span>

 <span class="nd">@dataclass</span>
 <span class="k">class</span> <span class="nc">TRECExtendedData</span><span class="p">(</span><span class="n">TrecData</span><span class="p">):</span>
     <span class="n">rationale</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span>
         <span class="n">metadata</span><span class="o">=</span><span class="p">{</span>
             <span class="s2">&quot;desc&quot;</span><span class="p">:</span> <span class="s2">&quot;Your step-by-step reasoning to classify the question to class_name&quot;</span>
         <span class="p">},</span>
         <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
     <span class="p">)</span>
     <span class="n">__input_fields__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;question&quot;</span><span class="p">]</span>
     <span class="n">__output_fields__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;rationale&quot;</span><span class="p">,</span> <span class="s2">&quot;class_name&quot;</span><span class="p">]</span> <span class="c1"># it is important to have the rationale before the class_name</span>
</pre></div>
</div>
<p>We will subclass from <code class="docutils literal notranslate"><span class="pre">Component</span></code> for our final task pipeline.
We use <a class="reference internal" href="../apis/components/components.output_parsers.dataclass_parser.html#components.output_parsers.dataclass_parser.DataClassParser" title="components.output_parsers.dataclass_parser.DataClassParser"><code class="xref py py-class docutils literal notranslate"><span class="pre">DataClassParser</span></code></a> to streamline the process of output formatting and parsing.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TRECClassifierStructuredOutput</span><span class="p">(</span><span class="n">adal</span><span class="o">.</span><span class="n">Component</span><span class="p">):</span>

     <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_client</span><span class="p">:</span> <span class="n">adal</span><span class="o">.</span><span class="n">ModelClient</span><span class="p">,</span> <span class="n">model_kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
         <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

         <span class="n">label_desc</span> <span class="o">=</span> <span class="p">[</span>
             <span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">label</span><span class="p">,</span> <span class="s2">&quot;desc&quot;</span><span class="p">:</span> <span class="n">desc</span><span class="p">}</span>
             <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">desc</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">_COARSE_LABELS</span><span class="p">,</span> <span class="n">_COARSE_LABELS_DESC</span><span class="p">)</span>
         <span class="p">]</span>

         <span class="n">task_desc_str</span> <span class="o">=</span> <span class="n">adal</span><span class="o">.</span><span class="n">Prompt</span><span class="p">(</span>
             <span class="n">template</span><span class="o">=</span><span class="n">task_desc_template</span><span class="p">,</span> <span class="n">prompt_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;classes&quot;</span><span class="p">:</span> <span class="n">label_desc</span><span class="p">}</span>
         <span class="p">)()</span>

         <span class="bp">self</span><span class="o">.</span><span class="n">data_class</span> <span class="o">=</span> <span class="n">TRECExtendedData</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">data_class</span><span class="o">.</span><span class="n">set_task_desc</span><span class="p">(</span><span class="n">task_desc_str</span><span class="p">)</span>

         <span class="bp">self</span><span class="o">.</span><span class="n">parser</span> <span class="o">=</span> <span class="n">adal</span><span class="o">.</span><span class="n">DataClassParser</span><span class="p">(</span>
             <span class="n">data_class</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_class</span><span class="p">,</span> <span class="n">return_data_class</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">format_type</span><span class="o">=</span><span class="s2">&quot;yaml&quot;</span>
         <span class="p">)</span>

         <span class="n">prompt_kwargs</span> <span class="o">=</span> <span class="p">{</span>
             <span class="s2">&quot;system_prompt&quot;</span><span class="p">:</span> <span class="n">adal</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
                 <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get_task_desc_str</span><span class="p">(),</span>
                 <span class="n">role_desc</span><span class="o">=</span><span class="s2">&quot;Task description&quot;</span><span class="p">,</span>
                 <span class="n">requires_opt</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">param_type</span><span class="o">=</span><span class="n">adal</span><span class="o">.</span><span class="n">ParameterType</span><span class="o">.</span><span class="n">PROMPT</span><span class="p">,</span>
             <span class="p">),</span>
             <span class="s2">&quot;output_format_str&quot;</span><span class="p">:</span> <span class="n">adal</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
                 <span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get_output_format_str</span><span class="p">(),</span>
                 <span class="n">role_desc</span><span class="o">=</span><span class="s2">&quot;Output format requirements&quot;</span><span class="p">,</span>
                 <span class="n">requires_opt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">param_type</span><span class="o">=</span><span class="n">adal</span><span class="o">.</span><span class="n">ParameterType</span><span class="o">.</span><span class="n">PROMPT</span><span class="p">,</span>
             <span class="p">),</span>
             <span class="s2">&quot;few_shot_demos&quot;</span><span class="p">:</span> <span class="n">adal</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
                 <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">requires_opt</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">role_desc</span><span class="o">=</span><span class="s2">&quot;Few shot examples to help the model&quot;</span><span class="p">,</span>
                 <span class="n">param_type</span><span class="o">=</span><span class="n">adal</span><span class="o">.</span><span class="n">ParameterType</span><span class="o">.</span><span class="n">DEMOS</span><span class="p">,</span>
             <span class="p">),</span>
         <span class="p">}</span>

         <span class="bp">self</span><span class="o">.</span><span class="n">llm</span> <span class="o">=</span> <span class="n">adal</span><span class="o">.</span><span class="n">Generator</span><span class="p">(</span>
             <span class="n">model_client</span><span class="o">=</span><span class="n">model_client</span><span class="p">,</span>
             <span class="n">model_kwargs</span><span class="o">=</span><span class="n">model_kwargs</span><span class="p">,</span>
             <span class="n">prompt_kwargs</span><span class="o">=</span><span class="n">prompt_kwargs</span><span class="p">,</span>
             <span class="n">template</span><span class="o">=</span><span class="n">template</span><span class="p">,</span>
             <span class="n">output_processors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="p">,</span>
             <span class="n">use_cache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
         <span class="p">)</span>

     <span class="k">def</span> <span class="nf">_prepare_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">question</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
         <span class="n">input_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_class</span><span class="p">(</span><span class="n">question</span><span class="o">=</span><span class="n">question</span><span class="p">)</span>
         <span class="n">input_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">get_input_str</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
         <span class="n">prompt_kwargs</span> <span class="o">=</span> <span class="p">{</span>
             <span class="s2">&quot;input_str&quot;</span><span class="p">:</span> <span class="n">adal</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
                 <span class="n">data</span><span class="o">=</span><span class="n">input_str</span><span class="p">,</span> <span class="n">requires_opt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">role_desc</span><span class="o">=</span><span class="s2">&quot;input to the LLM&quot;</span>
             <span class="p">)</span>
         <span class="p">}</span>
         <span class="k">return</span> <span class="n">prompt_kwargs</span>

     <span class="k">def</span> <span class="nf">call</span><span class="p">(</span>
         <span class="bp">self</span><span class="p">,</span> <span class="n">question</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
     <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">adal</span><span class="o">.</span><span class="n">GeneratorOutput</span><span class="p">,</span> <span class="n">adal</span><span class="o">.</span><span class="n">Parameter</span><span class="p">]:</span>
         <span class="n">prompt_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_input</span><span class="p">(</span><span class="n">question</span><span class="p">)</span>
         <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="p">(</span><span class="n">prompt_kwargs</span><span class="o">=</span><span class="n">prompt_kwargs</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>
         <span class="k">return</span> <span class="n">output</span>
</pre></div>
</div>
<p>In this taske pipeline, we have prepared two trainable prameters: <code class="docutils literal notranslate"><span class="pre">system_prompt</span></code> and <code class="docutils literal notranslate"><span class="pre">few_shot_demos</span></code> and each is of type <code class="docutils literal notranslate"><span class="pre">adal.ParameterType.PROMPT</span></code> and <code class="docutils literal notranslate"><span class="pre">adal.ParameterType.DEMOS</span></code> respectively.
We will need <a class="reference internal" href="../apis/optim/optim.text_grad.tgd_optimizer.html#optim.text_grad.tgd_optimizer.TGDOptimizer" title="optim.text_grad.tgd_optimizer.TGDOptimizer"><code class="xref py py-class docutils literal notranslate"><span class="pre">TGDOptimizer</span></code></a> to optimize <code class="docutils literal notranslate"><span class="pre">system_prompt</span></code> and <a class="reference internal" href="../apis/optim/optim.few_shot.bootstrap_optimizer.html#optim.few_shot.bootstrap_optimizer.BootstrapFewShot" title="optim.few_shot.bootstrap_optimizer.BootstrapFewShot"><code class="xref py py-class docutils literal notranslate"><span class="pre">BootstrapOptimizer</span></code></a>
to optimize <code class="docutils literal notranslate"><span class="pre">few_shot_demos</span></code>.</p>
</section>
<section id="define-the-adalcomponent">
<h2>Define the AdalComponent<a class="headerlink" href="#define-the-adalcomponent" title="Link to this heading">¶</a></h2>
<p>Now, we will define a subclass of <code class="docutils literal notranslate"><span class="pre">AdalComponent</span></code> to prepare the pipeline for training.
We have set up the <code class="docutils literal notranslate"><span class="pre">eval_fn</span></code>, <code class="docutils literal notranslate"><span class="pre">loss_fn</span></code>, along with methods to configure backward engine for the text optimizer,
as well as a method method to configure teacher generator for the demo optimizer.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TrecClassifierAdal</span><span class="p">(</span><span class="n">adal</span><span class="o">.</span><span class="n">AdalComponent</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model_client</span><span class="p">:</span> <span class="n">adal</span><span class="o">.</span><span class="n">ModelClient</span><span class="p">,</span>
        <span class="n">model_kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
        <span class="n">teacher_model_config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
        <span class="n">backward_engine_model_config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
        <span class="n">text_optimizer_model_config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">TRECClassifierStructuredOutput</span><span class="p">(</span><span class="n">model_client</span><span class="p">,</span> <span class="n">model_kwargs</span><span class="p">)</span>
        <span class="n">eval_fn</span> <span class="o">=</span> <span class="n">AnswerMatchAcc</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;exact_match&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">compute_single_item</span>
        <span class="n">loss_fn</span> <span class="o">=</span> <span class="n">adal</span><span class="o">.</span><span class="n">EvalFnToTextLoss</span><span class="p">(</span>
            <span class="n">eval_fn</span><span class="o">=</span><span class="n">eval_fn</span><span class="p">,</span>
            <span class="n">eval_fn_desc</span><span class="o">=</span><span class="s2">&quot;exact_match: 1 if str(y) == str(y_gt) else 0&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">,</span>
            <span class="n">eval_fn</span><span class="o">=</span><span class="n">eval_fn</span><span class="p">,</span>
            <span class="n">loss_fn</span><span class="o">=</span><span class="n">loss_fn</span><span class="p">,</span>
            <span class="n">backward_engine_model_config</span><span class="o">=</span><span class="n">backward_engine_model_config</span><span class="p">,</span>
            <span class="n">text_optimizer_model_config</span><span class="o">=</span><span class="n">text_optimizer_model_config</span><span class="p">,</span>
            <span class="n">teacher_model_config</span><span class="o">=</span><span class="n">teacher_model_config</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">prepare_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample</span><span class="p">:</span> <span class="n">TRECExtendedData</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">call</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;question&quot;</span><span class="p">:</span> <span class="n">sample</span><span class="o">.</span><span class="n">question</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">sample</span><span class="o">.</span><span class="n">id</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">prepare_eval</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">sample</span><span class="p">:</span> <span class="n">TRECExtendedData</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">:</span> <span class="n">adal</span><span class="o">.</span><span class="n">GeneratorOutput</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">y_label</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">y_pred</span> <span class="ow">and</span> <span class="n">y_pred</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">y_pred</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">class_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">y_label</span> <span class="o">=</span> <span class="n">y_pred</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">class_name</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_fn</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">y_label</span><span class="p">,</span> <span class="s2">&quot;y_gt&quot;</span><span class="p">:</span> <span class="n">sample</span><span class="o">.</span><span class="n">class_name</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">prepare_loss</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">sample</span><span class="p">:</span> <span class="n">TRECExtendedData</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">:</span> <span class="n">adal</span><span class="o">.</span><span class="n">Parameter</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">Dict</span><span class="p">]:</span>
        <span class="n">full_response</span> <span class="o">=</span> <span class="n">y_pred</span><span class="o">.</span><span class="n">full_response</span>
        <span class="n">y_label</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">full_response</span>
            <span class="ow">and</span> <span class="n">full_response</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">full_response</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">class_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="n">y_label</span> <span class="o">=</span> <span class="n">full_response</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">class_name</span>

        <span class="n">y_pred</span><span class="o">.</span><span class="n">eval_input</span> <span class="o">=</span> <span class="n">y_label</span>
        <span class="n">y_gt</span> <span class="o">=</span> <span class="n">adal</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;y_gt&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">sample</span><span class="o">.</span><span class="n">class_name</span><span class="p">,</span>
            <span class="n">eval_input</span><span class="o">=</span><span class="n">sample</span><span class="o">.</span><span class="n">class_name</span><span class="p">,</span>
            <span class="n">requires_opt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss_fn</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;kwargs&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">y_pred</span><span class="p">,</span> <span class="s2">&quot;y_gt&quot;</span><span class="p">:</span> <span class="n">y_gt</span><span class="p">}}</span>
</pre></div>
</div>
</section>
<section id="trainer-and-training-strategy">
<h2>Trainer and Training Strategy<a class="headerlink" href="#trainer-and-training-strategy" title="Link to this heading">¶</a></h2>
<p><strong>Training Strategy</strong></p>
<p>The following code shows our default training configuration. We use a batch size of 4, 12 steps, and 4 workers to call LLMs in parallel.
The <code class="docutils literal notranslate"><span class="pre">optimize_order</span></code> is set to <code class="docutils literal notranslate"><span class="pre">sequential</span></code> to first train the text optimizer and then the demo optimizer.
This training strategy has been working well. With the text optimized, this might boost the performance for the teacher model.
With the teacher model’s reasoning, the demo optimizer can learn to reason better even with merefly one demonstration from the teacher.
When we are at the <code class="docutils literal notranslate"><span class="pre">sequential</span></code> optimization order, we will end up with 24 steps trained.</p>
<p>In addition, you can try <code class="docutils literal notranslate"><span class="pre">mixed</span></code> for the optimization order, where at each step, it will update both the text optimizer and the demo optimizer.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">train</span><span class="p">(</span>
    <span class="n">model_client</span><span class="p">:</span> <span class="n">adal</span><span class="o">.</span><span class="n">ModelClient</span><span class="p">,</span>
    <span class="n">model_kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
    <span class="n">train_batch_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>  <span class="c1"># larger batch size is not that effective, probably because of llm&#39;s lost in the middle</span>
    <span class="n">raw_shots</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">bootstrap_shots</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">max_steps</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
    <span class="n">num_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;constrained&quot;</span><span class="p">,</span>
    <span class="n">optimization_order</span><span class="o">=</span><span class="s2">&quot;sequential&quot;</span><span class="p">,</span>
    <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
    <span class="c1"># TODO: ensure the teacher prompt gets updated with the new model</span>
    <span class="n">adal_component</span> <span class="o">=</span> <span class="n">TrecClassifierAdal</span><span class="p">(</span>
        <span class="n">model_client</span><span class="o">=</span><span class="n">model_client</span><span class="p">,</span>
        <span class="n">model_kwargs</span><span class="o">=</span><span class="n">model_kwargs</span><span class="p">,</span>
        <span class="n">text_optimizer_model_config</span><span class="o">=</span><span class="n">gpt_4o_model</span><span class="p">,</span>
        <span class="n">backward_engine_model_config</span><span class="o">=</span><span class="n">gpt_4o_model</span><span class="p">,</span>
        <span class="n">teacher_model_config</span><span class="o">=</span><span class="n">gpt_4o_model</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">adal_component</span><span class="p">)</span>
    <span class="n">trainer</span> <span class="o">=</span> <span class="n">adal</span><span class="o">.</span><span class="n">Trainer</span><span class="p">(</span>
        <span class="n">train_batch_size</span><span class="o">=</span><span class="n">train_batch_size</span><span class="p">,</span>
        <span class="n">adaltask</span><span class="o">=</span><span class="n">adal_component</span><span class="p">,</span>
        <span class="n">strategy</span><span class="o">=</span><span class="n">strategy</span><span class="p">,</span>
        <span class="n">max_steps</span><span class="o">=</span><span class="n">max_steps</span><span class="p">,</span>
        <span class="n">num_workers</span><span class="o">=</span><span class="n">num_workers</span><span class="p">,</span>
        <span class="n">raw_shots</span><span class="o">=</span><span class="n">raw_shots</span><span class="p">,</span>
        <span class="n">bootstrap_shots</span><span class="o">=</span><span class="n">bootstrap_shots</span><span class="p">,</span>
        <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span>
        <span class="n">weighted_sampling</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">optimization_order</span><span class="o">=</span><span class="n">optimization_order</span><span class="p">,</span>
        <span class="n">exclude_input_fields_from_bootstrap_demos</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">trainer</span><span class="p">)</span>

    <span class="n">train_dataset</span><span class="p">,</span> <span class="n">val_dataset</span><span class="p">,</span> <span class="n">test_dataset</span> <span class="o">=</span> <span class="n">load_datasets</span><span class="p">()</span>
    <span class="n">trainer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
        <span class="n">train_dataset</span><span class="o">=</span><span class="n">train_dataset</span><span class="p">,</span>
        <span class="n">val_dataset</span><span class="o">=</span><span class="n">test_dataset</span><span class="p">,</span>
        <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>In this case, we did not use <code class="docutils literal notranslate"><span class="pre">val_dataset</span></code> as we did diagnose and as shown in Table 1, the val dataset is not a good indicator for the test accuracy.
Thus, our final training strategy is to directly validate on the test dataset.</p>
<p><strong>Training checkpoints</strong>:</p>
<p>At the end of the training, we will print out the ckpt path where you can look up all the details about the trained prompt.
Here is our above training:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>Loading<span class="w"> </span>Data:<span class="w"> </span><span class="m">100</span>%<span class="p">|</span>█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████<span class="p">|</span><span class="w"> </span><span class="m">144</span>/144<span class="w"> </span><span class="o">[</span><span class="m">00</span>:00&lt;<span class="m">00</span>:00,<span class="w"> </span><span class="m">51011</span>.81it/s<span class="o">]</span>
Evaluating<span class="w"> </span>step<span class="o">(</span><span class="m">24</span><span class="o">)</span>:<span class="w"> </span><span class="m">0</span>.8426<span class="w"> </span>across<span class="w"> </span><span class="m">108</span><span class="w"> </span>samples,<span class="w"> </span>Max<span class="w"> </span>potential:<span class="w"> </span><span class="m">0</span>.8819:<span class="w">  </span><span class="m">75</span>%<span class="p">|</span>█████████████████████████████████████████████████████████████████████▊<span class="w">                       </span><span class="p">|</span><span class="w"> </span><span class="m">108</span>/144<span class="w"> </span><span class="o">[</span><span class="m">00</span>:00&lt;<span class="m">00</span>:00,<span class="w"> </span><span class="m">1855</span>.48it/s<span class="o">]</span>
Fail<span class="w"> </span>validation:<span class="w"> </span><span class="m">0</span>.8348623853211009<span class="w"> </span>&lt;<span class="o">=</span><span class="w"> </span><span class="m">0</span>.8819444444444444,<span class="w"> </span>revert
Training<span class="w"> </span>Step:<span class="w"> </span><span class="m">24</span>:<span class="w"> </span><span class="m">100</span>%<span class="p">|</span>█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████<span class="p">|</span><span class="w"> </span><span class="m">12</span>/12<span class="w"> </span><span class="o">[</span><span class="m">03</span>:05&lt;<span class="m">00</span>:00,<span class="w"> </span><span class="m">15</span>.46s/it<span class="o">]</span>
Saved<span class="w"> </span>ckpt<span class="w"> </span>to<span class="w"> </span>/Users/liyin/.adalflow/ckpt/TrecClassifierAdal/constrained_max_steps_12_848d2_run_7.json
Training<span class="w"> </span>time:<span class="w"> </span><span class="m">823</span>.8977522850037s
</pre></div>
</div>
<p>We can see that the training takes only 14 minutes.
We use 12 steps, and the learning curve is shown in Fig 1.
Here is our trained system prompt and the demo prompt:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">system_prompt</span> <span class="o">=</span> <span class="s2">&quot;You are a classifier. Given a question, you need to classify it into one of the following classes:</span><span class="se">\n</span><span class="s2">Format: class_index. class_name, class_description</span><span class="se">\n</span><span class="s2">0. ABBR, Abbreviation or acronym</span><span class="se">\n</span><span class="s2">1. ENTY, Entity, including specific terms, brand names, or other distinct entities</span><span class="se">\n</span><span class="s2">2. DESC, Description and abstract concept, including explanations, characteristics, and meanings</span><span class="se">\n</span><span class="s2">3. HUM, Human being</span><span class="se">\n</span><span class="s2">4. LOC, Location, including spatial information, geographical places</span><span class="se">\n</span><span class="s2">5. NUM, Numeric value, including measurable figures, quantities, distances, and time</span><span class="se">\n</span><span class="s2">- Focus on correctly identifying the class based on the question&#39;s main inquiry:&quot;</span>
<span class="n">few_shot_demos</span> <span class="o">=</span> <span class="s2">&quot;rationale: The question is asking for a specific term used to describe the sum of</span><span class="se">\n</span><span class="s2">  all genetic material in an organism.</span><span class="se">\n</span><span class="s2">class_name: ENTY&quot;</span>
</pre></div>
</div>
<p>We can see that compared with our initial prompt, it adds some concise explanation to each class.
The demo prompt is also short, directly from a teacher model teaching the student model to do rationale to reach to the final class_name.</p>
</section>
<section id="performance-benchmark">
<h2>Performance &amp; Benchmark<a class="headerlink" href="#performance-benchmark" title="Link to this heading">¶</a></h2>
<p>We implemented Dspy Boostrap few-shot with random search.</p>
<p>Here is the DsPy’s Signature (similar to the prompt) where its task description is a direct copy our AdalFlow’s starting prompt:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">GenerateAnswer</span><span class="p">(</span><span class="n">dspy</span><span class="o">.</span><span class="n">Signature</span><span class="p">):</span>
<span class="w">     </span><span class="sd">&quot;&quot;&quot;You are a classifier. Given a question, you need to classify it into one of the following classes:</span>
<span class="sd">     Format: class_index. class_name, class_description</span>
<span class="sd">     1. ABBR, Abbreviation</span>
<span class="sd">     2. ENTY, Entity</span>
<span class="sd">     3. DESC, Description and abstract concept</span>
<span class="sd">     4. HUM, Human being</span>
<span class="sd">     5. LOC, Location</span>
<span class="sd">     6. NUM, Numeric value</span>
<span class="sd">     - Do not try to answer the question:&quot;&quot;&quot;</span>

     <span class="n">question</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">InputField</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Question to be classified&quot;</span><span class="p">)</span>
     <span class="n">answer</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">dspy</span><span class="o">.</span><span class="n">OutputField</span><span class="p">(</span>
         <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Select one from ABBR, ENTY, DESC, HUM, LOC, NUM&quot;</span>
     <span class="p">)</span>
</pre></div>
</div>
<p>Here is the performance result</p>
<div class="table-wrapper colwidths-given docutils container" id="id3">
<table class="docutils align-default" id="id3">
<caption><span class="caption-text">AdalFlow vs DsPy on GPT-3.5-turbo</span><a class="headerlink" href="#id3" title="Link to this table">¶</a></caption>
<colgroup>
<col style="width: 25.0%" />
<col style="width: 25.0%" />
<col style="width: 25.0%" />
<col style="width: 25.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Method</p></th>
<th class="head"><p>Train</p></th>
<th class="head"><p>Val</p></th>
<th class="head"><p>Test</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Start (manual prompt)</p></td>
<td><p>67.5% (20*6 samples)</p></td>
<td><p>69.4% (6*6 samples)</p></td>
<td><p>82.64% (144 samples)</p></td>
</tr>
<tr class="row-odd"><td><p>Start (GPT-4o/Teacher)</p></td>
<td><p>77.5%</p></td>
<td><p>77.78%</p></td>
<td><p>86.11%</p></td>
</tr>
<tr class="row-even"><td><p>DsPy (Start)</p></td>
<td><p>57.5%</p></td>
<td><p>61.1%</p></td>
<td><p>60.42%</p></td>
</tr>
<tr class="row-odd"><td><p>DsPy (bootstrap 4-shots + raw 36-shots)</p></td>
<td><p>N/A</p></td>
<td><p>86.1%</p></td>
<td><p>82.6%</p></td>
</tr>
<tr class="row-even"><td><p>AdalFlow (Optimized Zero-shot)</p></td>
<td><p>N/A</p></td>
<td><p>77.78%, 80.5% (<strong>+8.4%</strong>)</p></td>
<td><p>86.81%, 89.6% (<strong>+4.2%</strong>)</p></td>
</tr>
<tr class="row-odd"><td><p>AdalFlow (Optimized Zero-shot + bootstrap 1-shot)</p></td>
<td><p>N/A</p></td>
<td><p>N/A</p></td>
<td><p>88.19%</p></td>
</tr>
<tr class="row-even"><td><p>AdalFlow (Optimized Zero-shot + bootstrap 1-shot + 40 raw shots)</p></td>
<td><p>N/A</p></td>
<td><p><strong>86.1%</strong></p></td>
<td><p><strong>90.28%</strong></p></td>
</tr>
<tr class="row-odd"><td><p>AdalFlow (Optimized Zero-shot on GPT-4o)</p></td>
<td><p>77.8%</p></td>
<td><p>77.78%</p></td>
<td><p>84.03%</p></td>
</tr>
</tbody>
</table>
</div>
<p>In this case, our text optimizer–Text-Grad 2.0 is able to close the gap to the teacher model, leaving little space for the DemoOptimizer to improve as it learns to boost its reasoning from a teacher model’s reasoning.
Even though the many-shots (as many as 40) can still improve the performance for a bit, but it will adds a lot more tokens.</p>
<p>We can see that being able to flexibly control the prompt instead of delegate to a fixed <code class="docutils literal notranslate"><span class="pre">Signature</span></code> is advantageous.
We use <code class="docutils literal notranslate"><span class="pre">yaml</span></code> format for the output in this case, and be able to use template to control which part we want to train.
We trained to train a joined <code class="docutils literal notranslate"><span class="pre">Parameter</span></code> with both the system prompt and the output format, and found it is more effecitive to just train the system prompt.</p>
<p><strong>Conclusion</strong>:</p>
<p>Our SOTA performance is due to the combination of</p>
<ol class="arabic simple">
<li><p>Our research on optimizers: Each individual optimizer, the text optimizer implementing our research Text-grad 2.0 and the demo optimizer implementing our research <code class="docutils literal notranslate"><span class="pre">Learn-to-reason</span> <span class="pre">Few-shot</span> <span class="pre">In-context</span> <span class="pre">Learning</span></code></p></li>
<li><p>Our research on training paradigm: The sequential training where we first train the text optimizer and then train the demo optimizer is proven to be effective to optimize the performe without adding too many tokens in the prompt.</p></li>
<li><p>The flexibility and customizability of the library: With the library to provide developers direct control over the prompt and allow flexible and granular definition of the parameters is the second of the reason that we can surpass other methods by a large margin.</p></li>
</ol>
<div class="highlight admonition">
<p class="admonition-title">API reference</p>
<ul class="simple">
<li><p><a class="reference internal" href="../apis/optim/optim.parameter.html#optim.parameter.Parameter" title="optim.parameter.Parameter"><code class="xref py py-class docutils literal notranslate"><span class="pre">optim.parameter.Parameter</span></code></a></p></li>
<li><p><a class="reference internal" href="../apis/optim/optim.trainer.trainer.html#optim.trainer.trainer.Trainer" title="optim.trainer.trainer.Trainer"><code class="xref py py-class docutils literal notranslate"><span class="pre">optim.trainer.trainer.Trainer</span></code></a></p></li>
<li><p><a class="reference internal" href="../apis/optim/optim.trainer.adal.html#optim.trainer.adal.AdalComponent" title="optim.trainer.adal.AdalComponent"><code class="xref py py-class docutils literal notranslate"><span class="pre">optim.trainer.adal.AdalComponent</span></code></a></p></li>
<li><p><a class="reference internal" href="../apis/components/components.output_parsers.dataclass_parser.html#components.output_parsers.dataclass_parser.DataClassParser" title="components.output_parsers.dataclass_parser.DataClassParser"><code class="xref py py-class docutils literal notranslate"><span class="pre">components.output_parsers.dataclass_parser.DataClassParser</span></code></a></p></li>
<li><p><a class="reference internal" href="../apis/optim/optim.text_grad.tgd_optimizer.html#optim.text_grad.tgd_optimizer.TGDOptimizer" title="optim.text_grad.tgd_optimizer.TGDOptimizer"><code class="xref py py-class docutils literal notranslate"><span class="pre">optim.text_grad.tgd_optimizer.TGDOptimizer</span></code></a></p></li>
<li><p><a class="reference internal" href="../apis/optim/optim.few_shot.bootstrap_optimizer.html#optim.few_shot.bootstrap_optimizer.BootstrapFewShot" title="optim.few_shot.bootstrap_optimizer.BootstrapFewShot"><code class="xref py py-class docutils literal notranslate"><span class="pre">optim.few_shot.bootstrap_optimizer.BootstrapFewShot</span></code></a></p></li>
</ul>
</div>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="rag_opt.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">RAG optimization</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="qa_demo_trace_graph.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Q&amp;A Few Shot Demo Trace Graph</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2025, SylphAI, Inc
            </div>
            Made with 
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Classification Optimization</a><ul>
<li><a class="reference internal" href="#task-pipeline-with-structured-output">Task Pipeline with Structured Output</a></li>
<li><a class="reference internal" href="#define-the-adalcomponent">Define the AdalComponent</a></li>
<li><a class="reference internal" href="#trainer-and-training-strategy">Trainer and Training Strategy</a></li>
<li><a class="reference internal" href="#performance-benchmark">Performance &amp; Benchmark</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/furo.js?v=5fa4622c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script src="../_static/js/rtd_search_config.js"></script>
    <script src="../_static/js/rtd_sphinx_search.min.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    </body>
</html>