
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>core.generator &#8212; LightRAG: The Lightning Library for LLM Applications</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css?v=5422b685" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=87e54e7c" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/rtd_sphinx_search.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script src="../../_static/js/rtd_search_config.js"></script>
    <script src="../../_static/js/rtd_sphinx_search.min.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/core/generator';</script>
    <link rel="icon" href="../../_static/LightRAG-logo-circle.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/adalflow-logo.png" class="logo__image only-light" alt="LightRAG: The Lightning Library for LLM Applications - Home"/>
    <script>document.write(`<img src="../../_static/adalflow-logo.png" class="logo__image only-dark" alt="LightRAG: The Lightning Library for LLM Applications - Home"/>`);</script>
  
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../get_started/index.html">
    Get Started
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../tutorials/index.html">
    Developer Notes
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../use_cases/index.html">
    Use Cases
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../apis/index.html">
    API Reference
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
        </div>
      
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/SylphAI-Inc/LightRAG" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://discord.gg/ezzszrRZvT" title="Discord" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-discord fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Discord</span></a>
        </li>
</ul></div>
      
        <div class="navbar-item">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../get_started/index.html">
    Get Started
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../tutorials/index.html">
    Developer Notes
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../use_cases/index.html">
    Use Cases
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../apis/index.html">
    API Reference
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/SylphAI-Inc/LightRAG" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://discord.gg/ezzszrRZvT" title="Discord" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-discord fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Discord</span></a>
        </li>
</ul></div>
        
          <div class="navbar-item">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../index.html" class="nav-link">Module code</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">core.generator</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for core.generator</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Generator is a user-facing orchestration component with a simple and unified interface for LLM prediction.</span>

<span class="sd">It is a pipeline that consists of three subcomponents.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">List</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">import</span> <span class="nn">logging</span>


<span class="kn">from</span> <span class="nn">adalflow.core.types</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ModelType</span><span class="p">,</span>
    <span class="n">GeneratorOutput</span><span class="p">,</span>
    <span class="n">GeneratorOutputType</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">adalflow.core.component</span> <span class="kn">import</span> <span class="n">Component</span>
<span class="kn">from</span> <span class="nn">adalflow.optim.grad_component</span> <span class="kn">import</span> <span class="n">GradComponent</span>
<span class="kn">from</span> <span class="nn">adalflow.core.base_data_class</span> <span class="kn">import</span> <span class="n">DataClass</span>


<span class="kn">from</span> <span class="nn">adalflow.optim.parameter</span> <span class="kn">import</span> <span class="n">Parameter</span><span class="p">,</span> <span class="n">GradientContext</span>
<span class="kn">from</span> <span class="nn">adalflow.optim.types</span> <span class="kn">import</span> <span class="n">ParameterType</span>

<span class="kn">from</span> <span class="nn">adalflow.core.prompt_builder</span> <span class="kn">import</span> <span class="n">Prompt</span>
<span class="kn">from</span> <span class="nn">adalflow.core.functional</span> <span class="kn">import</span> <span class="n">compose_model_kwargs</span>
<span class="kn">from</span> <span class="nn">adalflow.core.model_client</span> <span class="kn">import</span> <span class="n">ModelClient</span>
<span class="kn">from</span> <span class="nn">adalflow.core.default_prompt_template</span> <span class="kn">import</span> <span class="n">DEFAULT_LIGHTRAG_SYSTEM_PROMPT</span>
<span class="kn">from</span> <span class="nn">adalflow.optim.function</span> <span class="kn">import</span> <span class="n">BackwardContext</span>
<span class="kn">from</span> <span class="nn">adalflow.utils.cache</span> <span class="kn">import</span> <span class="n">CachedEngine</span>
<span class="kn">from</span> <span class="nn">adalflow.tracing.callback_manager</span> <span class="kn">import</span> <span class="n">CallbackManager</span>
<span class="kn">from</span> <span class="nn">adalflow.utils.global_config</span> <span class="kn">import</span> <span class="n">get_adalflow_default_root_path</span>

<span class="kn">from</span> <span class="nn">adalflow.optim.text_grad.backend_engine_prompt</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">FEEDBACK_ENGINE_TEMPLATE</span><span class="p">,</span>
    <span class="n">LLM_CONVERSATION_TEMPLATE</span><span class="p">,</span>
    <span class="n">VARIABLE_AND_PEERS_INFO</span><span class="p">,</span>
    <span class="n">CONVERSATION_START_INSTRUCTION_BASE</span><span class="p">,</span>
    <span class="n">CONVERSATION_START_INSTRUCTION_CHAIN</span><span class="p">,</span>
    <span class="n">OBJECTIVE_INSTRUCTION_BASE</span><span class="p">,</span>
    <span class="n">OBJECTIVE_INSTRUCTION_CHAIN</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">PromptArgType</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Parameter</span><span class="p">]]</span>


<div class="viewcode-block" id="Generator">
<a class="viewcode-back" href="../../apis/core/core.generator.html#core.generator.Generator">[docs]</a>
<span class="k">class</span> <span class="nc">Generator</span><span class="p">(</span><span class="n">GradComponent</span><span class="p">,</span> <span class="n">CachedEngine</span><span class="p">,</span> <span class="n">CallbackManager</span><span class="p">):</span>
    <span class="vm">__doc__</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;An user-facing orchestration component for LLM prediction.</span>

<span class="s2">    It is also a GradComponent that can be used for backpropagation through the LLM model.</span>

<span class="s2">    By orchestrating the following three components along with their required arguments,</span>
<span class="s2">    it enables any LLM prediction with required task output format.</span>
<span class="s2">    - Prompt</span>
<span class="s2">    - Model client</span>
<span class="s2">    - Output processors</span>

<span class="s2">    Args:</span>
<span class="s2">        model_client (ModelClient): The model client to use for the generator.</span>
<span class="s2">        model_kwargs (Dict[str, Any], optional): The model kwargs to pass to the model client. Defaults to </span><span class="si">{}</span><span class="s2">. Please refer to :ref:`ModelClient&lt;components-model_client&gt;` for the details on how to set the model_kwargs for your specific model if it is from our library.</span>
<span class="s2">        template (Optional[str], optional): The template for the prompt.  Defaults to :ref:`DEFAULT_LIGHTRAG_SYSTEM_PROMPT&lt;core-default_prompt_template&gt;`.</span>
<span class="s2">        prompt_kwargs (Optional[Dict], optional): The preset prompt kwargs to fill in the variables in the prompt. Defaults to None.</span>
<span class="s2">        output_processors (Optional[Component], optional):  The output processors after model call. It can be a single component or a chained component via ``Sequential``. Defaults to None.</span>
<span class="s2">        trainable_params (Optional[List[str]], optional): The list of trainable parameters. Defaults to [].</span>

<span class="s2">    Note:</span>
<span class="s2">        The output_processors will be applied to the string output of the model completion. And the result will be stored in the data field of the output. And we encourage you to only use it to parse the response to data format you will use later.</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">model_type</span><span class="p">:</span> <span class="n">ModelType</span> <span class="o">=</span> <span class="n">ModelType</span><span class="o">.</span><span class="n">LLM</span>
    <span class="n">model_client</span><span class="p">:</span> <span class="n">ModelClient</span>  <span class="c1"># for better type checking</span>

    <span class="n">_use_cache</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">_kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="c1"># args for the model</span>
        <span class="n">model_client</span><span class="p">:</span> <span class="n">ModelClient</span><span class="p">,</span>  <span class="c1"># will be intialized in the main script</span>
        <span class="n">model_kwargs</span><span class="p">:</span> <span class="n">PromptArgType</span> <span class="o">=</span> <span class="p">{},</span>
        <span class="c1"># args for the prompt</span>
        <span class="n">template</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">prompt_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span>
        <span class="c1"># args for the output processing</span>
        <span class="n">output_processors</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Component</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="c1"># args for the cache</span>
        <span class="n">cache_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_cache</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;The default prompt is set to the DEFAULT_LIGHTRAG_SYSTEM_PROMPT. It has the following variables:</span>
<span class="sd">        - task_desc_str</span>
<span class="sd">        - tools_str</span>
<span class="sd">        - example_str</span>
<span class="sd">        - chat_history_str</span>
<span class="sd">        - context_str</span>
<span class="sd">        - steps_str</span>
<span class="sd">        You can preset the prompt kwargs to fill in the variables in the prompt using prompt_kwargs.</span>
<span class="sd">        But you can replace the prompt and set any variables you want and use the prompt_kwargs to fill in the variables.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_client</span><span class="p">,</span> <span class="n">ModelClient</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> requires a ModelClient instance for model_client, please pass it as OpenAIClient() or GroqAPIClient() for example.</span><span class="se">\</span>
<span class="s2">                    Got </span><span class="si">{</span><span class="n">model_client</span><span class="si">}</span><span class="s2"> instead.&quot;</span>
            <span class="p">)</span>

        <span class="n">template</span> <span class="o">=</span> <span class="n">template</span> <span class="ow">or</span> <span class="n">DEFAULT_LIGHTRAG_SYSTEM_PROMPT</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">prompt_kwargs</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">prompt_kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error copying the prompt_kwargs: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">prompt_kwargs</span> <span class="o">=</span> <span class="n">prompt_kwargs</span>

        <span class="c1"># Cache</span>
        <span class="n">model_str</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_client</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">model_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;default&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">_cache_path</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">get_adalflow_default_root_path</span><span class="p">()</span> <span class="k">if</span> <span class="n">cache_path</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">cache_path</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_cache_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cache_</span><span class="si">{</span><span class="n">model_str</span><span class="si">}</span><span class="s2">.db&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cache_path: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">CachedEngine</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_path</span><span class="p">)</span>
        <span class="n">Component</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">GradComponent</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">CallbackManager</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_init_prompt</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">prompt_kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model_kwargs</span> <span class="o">=</span> <span class="n">model_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># init the model client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_client</span> <span class="o">=</span> <span class="n">model_client</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">output_processors</span> <span class="o">=</span> <span class="n">output_processors</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">(</span><span class="n">prompt_kwargs</span><span class="p">)</span>

        <span class="c1"># end of trainable parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backward_engine</span><span class="p">:</span> <span class="s2">&quot;BackwardEngine&quot;</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generator </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> initialized.&quot;</span><span class="p">)</span>
        <span class="c1">#  to support better testing on the parts beside of the model call</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mock_output</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mock_output_data</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mock data&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_map_func</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_data_map_func</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_str</span> <span class="o">=</span> <span class="n">model_str</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use_cache</span> <span class="o">=</span> <span class="n">use_cache</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;model_client&quot;</span><span class="p">:</span> <span class="n">model_client</span><span class="p">,</span>
            <span class="s2">&quot;model_kwargs&quot;</span><span class="p">:</span> <span class="n">model_kwargs</span><span class="p">,</span>
            <span class="s2">&quot;template&quot;</span><span class="p">:</span> <span class="n">template</span><span class="p">,</span>
            <span class="s2">&quot;prompt_kwargs&quot;</span><span class="p">:</span> <span class="n">prompt_kwargs</span><span class="p">,</span>
            <span class="s2">&quot;output_processors&quot;</span><span class="p">:</span> <span class="n">output_processors</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
            <span class="s2">&quot;cache_path&quot;</span><span class="p">:</span> <span class="n">cache_path</span><span class="p">,</span>
            <span class="s2">&quot;use_cache&quot;</span><span class="p">:</span> <span class="n">use_cache</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_teacher</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Generator&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_default_mapping</span><span class="p">(</span>
        <span class="n">output</span><span class="p">:</span> <span class="s2">&quot;GeneratorOutput&quot;</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">output</span><span class="o">.</span><span class="n">data</span>
            <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">DataClass</span><span class="p">)</span>
            <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get_output_fields</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="p">):</span>
            <span class="n">output_fields</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get_output_fields</span><span class="p">()</span>

            <span class="n">output_mapping</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">f</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">f</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">output_fields</span>
            <span class="p">}</span>
        <span class="k">elif</span> <span class="n">output</span><span class="o">.</span><span class="n">raw_response</span><span class="p">:</span>
            <span class="n">output_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;raw_response&quot;</span><span class="p">]</span>
            <span class="n">output_mapping</span> <span class="o">=</span> <span class="p">{</span><span class="n">f</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">f</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">output_fields</span><span class="p">}</span>
            <span class="n">output_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Answer&quot;</span><span class="p">]</span>
            <span class="n">output_mapping</span><span class="p">[</span><span class="s2">&quot;Example&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_mapping</span><span class="p">[</span><span class="s2">&quot;raw_response&quot;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">output_mapping</span><span class="p">[</span><span class="s2">&quot;raw_response&quot;</span><span class="p">]</span>
        <span class="c1"># elif output.error:</span>
        <span class="c1">#     output_fields = [&quot;raw_response&quot;, &quot;error&quot;]</span>
        <span class="c1">#     output_mapping = {</span>
        <span class="c1">#         &quot;error&quot;: lambda x: x.error,</span>
        <span class="c1">#         &quot;raw_response&quot;: lambda x: x.raw_response,</span>
        <span class="c1">#     }</span>
        <span class="c1">#     output_fields = [&quot;Answer&quot;]</span>
        <span class="k">return</span> <span class="n">output_mapping</span><span class="p">,</span> <span class="n">output_fields</span>

<div class="viewcode-block" id="Generator.set_mock_output">
<a class="viewcode-back" href="../../apis/core/core.generator.html#core.generator.Generator.set_mock_output">[docs]</a>
    <span class="k">def</span> <span class="nf">set_mock_output</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">mock_output</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">mock_output_data</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mock data&quot;</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mock_output</span> <span class="o">=</span> <span class="n">mock_output</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mock_output_data</span> <span class="o">=</span> <span class="n">mock_output_data</span></div>


<div class="viewcode-block" id="Generator.reset_mock_output">
<a class="viewcode-back" href="../../apis/core/core.generator.html#core.generator.Generator.reset_mock_output">[docs]</a>
    <span class="k">def</span> <span class="nf">reset_mock_output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mock_output</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mock_output_data</span> <span class="o">=</span> <span class="s2">&quot;mock data&quot;</span></div>


<div class="viewcode-block" id="Generator.set_parameters">
<a class="viewcode-back" href="../../apis/core/core.generator.html#core.generator.Generator.set_parameters">[docs]</a>
    <span class="k">def</span> <span class="nf">set_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt_kwargs</span><span class="p">:</span> <span class="n">PromptArgType</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Set name for each paramter and set all context for each other.</span>
<span class="sd">        Make all parameters attributes to the generator for finding them easily</span>
<span class="sd">        for optimizers and other components.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">prompt_kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">Parameter</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">key</span>
                <span class="n">peers</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">p</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">prompt_kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">Parameter</span><span class="p">)</span> <span class="ow">and</span> <span class="n">k</span> <span class="o">!=</span> <span class="n">key</span>
                <span class="p">]</span>
                <span class="n">p</span><span class="o">.</span><span class="n">set_peers</span><span class="p">(</span><span class="n">peers</span><span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_init_prompt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prompt_kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialize the prompt with the template and prompt_kwargs.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="n">template</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prompt_kwargs</span> <span class="o">=</span> <span class="n">prompt_kwargs</span>
        <span class="c1"># NOTE: Prompt can handle parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prompt</span> <span class="o">=</span> <span class="n">Prompt</span><span class="p">(</span><span class="n">template</span><span class="o">=</span><span class="n">template</span><span class="p">,</span> <span class="n">prompt_kwargs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">prompt_kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="Generator.from_config">
<a class="viewcode-back" href="../../apis/core/core.generator.html#core.generator.Generator.from_config">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;Generator&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Create a Generator instance from the config dictionary.</span>

<span class="sd">        Example:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            config = {</span>
<span class="sd">                        &quot;model_client&quot;: {</span>
<span class="sd">                            &quot;component_name&quot;: &quot;OpenAIClient&quot;,</span>
<span class="sd">                            &quot;component_config&quot;: {}</span>
<span class="sd">                        },</span>
<span class="sd">                        &quot;model_kwargs&quot;: {&quot;model&quot;: &quot;gpt-3.5-turbo&quot;, &quot;temperature&quot;: 0}</span>
<span class="sd">                    }</span>
<span class="sd">            generator = Generator.from_config(config)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># create init_kwargs from the config</span>
        <span class="k">assert</span> <span class="s2">&quot;model_client&quot;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">,</span> <span class="s2">&quot;model_client is required in the config&quot;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">from_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_compose_model_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">model_kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The model configuration exclude the input itself.</span>
<span class="sd">        Combine the default model, model_kwargs with the passed model_kwargs.</span>
<span class="sd">        Example:</span>
<span class="sd">        model_kwargs = {&quot;temperature&quot;: 0.5, &quot;model&quot;: &quot;gpt-3.5-turbo&quot;}</span>
<span class="sd">        self.model_kwargs = {&quot;model&quot;: &quot;gpt-3.5-turbo&quot;}</span>
<span class="sd">        combine_kwargs(model_kwargs) =&gt; {&quot;temperature&quot;: 0.5, &quot;model&quot;: &quot;gpt-3.5-turbo&quot;}</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">combined_model_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">model_kwargs</span><span class="p">:</span>
            <span class="n">combined_model_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">model_kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">combined_model_kwargs</span>

<div class="viewcode-block" id="Generator.print_prompt">
<a class="viewcode-back" href="../../apis/core/core.generator.html#core.generator.Generator.print_prompt">[docs]</a>
    <span class="k">def</span> <span class="nf">print_prompt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># prompt_kwargs_str = _convert_prompt_kwargs_to_str(kwargs)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt</span><span class="o">.</span><span class="n">print_prompt</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="Generator.get_prompt">
<a class="viewcode-back" href="../../apis/core/core.generator.html#core.generator.Generator.get_prompt">[docs]</a>
    <span class="k">def</span> <span class="nf">get_prompt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># prompt_kwargs_str = _convert_prompt_kwargs_to_str(kwargs)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_extra_repr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;model_kwargs=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_kwargs</span><span class="si">}</span><span class="s2">, model_type=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_type</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="k">def</span> <span class="nf">_post_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">completion</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GeneratorOutput</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Get string completion and process it with the output_processors.&quot;&quot;&quot;</span>
        <span class="c1"># parse chat completion will only fill the raw_response</span>
        <span class="n">output</span><span class="p">:</span> <span class="n">GeneratorOutput</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_client</span><span class="o">.</span><span class="n">parse_chat_completion</span><span class="p">(</span><span class="n">completion</span><span class="p">)</span>
        <span class="c1"># Now adding the data filed to the output</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">raw_response</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_processors</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_processors</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing the output processors: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>

        <span class="k">return</span> <span class="n">output</span>

    <span class="k">def</span> <span class="nf">_pre_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt_kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">model_kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Prepare the input, prompt_kwargs, model_kwargs for the model call.&quot;&quot;&quot;</span>
        <span class="c1"># 1. render the prompt from the template</span>
        <span class="n">prompt_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="o">**</span><span class="n">prompt_kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="c1"># 2. combine the model_kwargs with the default model_kwargs</span>
        <span class="n">composed_model_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compose_model_kwargs</span><span class="p">(</span><span class="o">**</span><span class="n">model_kwargs</span><span class="p">)</span>

        <span class="c1"># 3. convert app&#39;s inputs to api inputs</span>
        <span class="n">api_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_client</span><span class="o">.</span><span class="n">convert_inputs_to_api_kwargs</span><span class="p">(</span>
            <span class="nb">input</span><span class="o">=</span><span class="n">prompt_str</span><span class="p">,</span>
            <span class="n">model_kwargs</span><span class="o">=</span><span class="n">composed_model_kwargs</span><span class="p">,</span>
            <span class="n">model_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_type</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">api_kwargs</span>

    <span class="k">def</span> <span class="nf">_model_client_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api_kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">use_cache</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="c1"># call the model client</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># check the cache</span>
            <span class="n">index_content</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">api_kwargs</span><span class="p">)</span>  <span class="c1"># + f&quot;training: {self.training}&quot;</span>
            <span class="k">if</span> <span class="n">use_cache</span><span class="p">:</span>
                <span class="c1"># print(f&quot;check cache first: {no_cache}&quot;)</span>

                <span class="n">cached_completion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_cache</span><span class="p">(</span><span class="n">index_content</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cached_completion</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">cached_completion</span>

            <span class="n">completion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_client</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
                <span class="n">api_kwargs</span><span class="o">=</span><span class="n">api_kwargs</span><span class="p">,</span> <span class="n">model_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_type</span>
            <span class="p">)</span>
            <span class="c1"># prepare cache</span>
            <span class="k">if</span> <span class="n">use_cache</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_save_cache</span><span class="p">(</span><span class="n">index_content</span><span class="p">,</span> <span class="n">completion</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">completion</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error calling the model: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span>

    <span class="c1">##############################################################################################################</span>
    <span class="c1">### Forward and backwards, and teacher generator are for training</span>
    <span class="c1">##############################################################################################################</span>

<div class="viewcode-block" id="Generator.create_demo_data_instance">
<a class="viewcode-back" href="../../apis/core/core.generator.html#core.generator.Generator.create_demo_data_instance">[docs]</a>
    <span class="k">def</span> <span class="nf">create_demo_data_instance</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_prompt_kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">output</span><span class="p">:</span> <span class="n">GeneratorOutput</span><span class="p">,</span>
        <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="kn">from</span> <span class="nn">adalflow.core.base_data_class</span> <span class="kn">import</span> <span class="n">DynamicDataClassFactory</span>

        <span class="c1"># map the input fields</span>
        <span class="n">demo_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="nb">id</span><span class="p">}</span>
        <span class="n">demo_data_class_output_mapping</span><span class="p">,</span> <span class="n">output_fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_default_mapping</span><span class="p">(</span>
            <span class="n">output</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">input_prompt_kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">demo_data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="c1"># map the output fields</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">demo_data_class_output_mapping</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">demo_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

        <span class="n">obj</span> <span class="o">=</span> <span class="n">DynamicDataClassFactory</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">demo_data</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">set_input_fields</span><span class="p">([</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">input_prompt_kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">set_output_fields</span><span class="p">(</span><span class="n">output_fields</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating the demo data instance:</span><span class="si">{</span><span class="n">demo_data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span></div>


<div class="viewcode-block" id="Generator.set_backward_engine">
<a class="viewcode-back" href="../../apis/core/core.generator.html#core.generator.Generator.set_backward_engine">[docs]</a>
    <span class="k">def</span> <span class="nf">set_backward_engine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backward_engine</span><span class="p">:</span> <span class="s2">&quot;BackwardEngine&quot;</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">backward_engine</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">backward_engine</span> <span class="o">=</span> <span class="n">BackwardEngine</span><span class="p">(</span>
                <span class="n">model_client</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_client</span><span class="p">,</span>
                <span class="n">model_kwargs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_kwargs</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mock_output</span><span class="p">:</span>
                <span class="n">backward_engine</span><span class="o">.</span><span class="n">set_mock_output</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backward_engine</span> <span class="o">=</span> <span class="n">backward_engine</span></div>


<div class="viewcode-block" id="Generator.set_teacher_generator">
<a class="viewcode-back" href="../../apis/core/core.generator.html#core.generator.Generator.set_teacher_generator">[docs]</a>
    <span class="k">def</span> <span class="nf">set_teacher_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">teacher</span><span class="p">:</span> <span class="s2">&quot;Generator&quot;</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_teacher</span> <span class="o">=</span> <span class="n">teacher</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Teacher generator set: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_teacher</span><span class="si">}</span><span class="s2">, teacher </span><span class="si">{</span><span class="n">teacher</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Teacher generator set: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_teacher</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Generator.set_data_map_func">
<a class="viewcode-back" href="../../apis/core/core.generator.html#core.generator.Generator.set_data_map_func">[docs]</a>
    <span class="k">def</span> <span class="nf">set_data_map_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">map_func</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">default_map_func</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="s2">&quot;GeneratorOutputType&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="n">data</span><span class="o">.</span><span class="n">data</span>
                <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span>
                <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">failure_message_to_backward_engine</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data_map_func</span> <span class="o">=</span> <span class="n">map_func</span> <span class="ow">or</span> <span class="n">default_map_func</span>

        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data map function set: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_map_func</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


    <span class="c1"># TODO: limit to only one demo parameter.</span>
<div class="viewcode-block" id="Generator.find_demo_parameter">
<a class="viewcode-back" href="../../apis/core/core.generator.html#core.generator.Generator.find_demo_parameter">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">find_demo_parameter</span><span class="p">(</span><span class="n">prompt_kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Parameter</span><span class="p">]:</span>
        <span class="kn">from</span> <span class="nn">adalflow.optim.parameter</span> <span class="kn">import</span> <span class="n">Parameter</span><span class="p">,</span> <span class="n">ParameterType</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">prompt_kwargs</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">Parameter</span><span class="p">)</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">param_type</span> <span class="o">==</span> <span class="n">ParameterType</span><span class="o">.</span><span class="n">DEMOS</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">p</span>
        <span class="k">return</span> <span class="kc">None</span></div>


    <span class="c1"># NOTE: when training is true, forward will be called in __call__ instead of call</span>
<div class="viewcode-block" id="Generator.forward">
<a class="viewcode-back" href="../../apis/core/core.generator.html#core.generator.Generator.forward">[docs]</a>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">prompt_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span>  <span class="c1"># the input need to be passed to the prompt</span>
        <span class="n">model_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span>
        <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Parameter&quot;</span><span class="p">:</span>
        <span class="c1"># 1. call the model</span>
        <span class="n">output</span><span class="p">:</span> <span class="n">GeneratorOutputType</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">input_args</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mock_output</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">GeneratorOutput</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mock_output_data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">teacher_mode</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_teacher</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Teacher generator is not set.&quot;</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using teacher: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_teacher</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">input_args</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;prompt_kwargs&quot;</span><span class="p">:</span> <span class="n">compose_model_kwargs</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_teacher</span><span class="o">.</span><span class="n">prompt_kwargs</span><span class="p">,</span> <span class="n">prompt_kwargs</span>
                    <span class="p">),</span>
                    <span class="s2">&quot;model_kwargs&quot;</span><span class="p">:</span> <span class="n">compose_model_kwargs</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_teacher</span><span class="o">.</span><span class="n">model_kwargs</span><span class="p">,</span> <span class="n">model_kwargs</span>
                    <span class="p">),</span>
                <span class="p">}</span>
                <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_teacher</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">prompt_kwargs</span><span class="p">,</span> <span class="n">model_kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">input_args</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;prompt_kwargs&quot;</span><span class="p">:</span> <span class="n">compose_model_kwargs</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">prompt_kwargs</span><span class="p">,</span> <span class="n">prompt_kwargs</span>
                    <span class="p">),</span>
                    <span class="s2">&quot;model_kwargs&quot;</span><span class="p">:</span> <span class="n">compose_model_kwargs</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">model_kwargs</span><span class="p">,</span> <span class="n">model_kwargs</span>
                    <span class="p">),</span>
                <span class="p">}</span>
                <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">prompt_kwargs</span><span class="p">,</span> <span class="n">model_kwargs</span><span class="p">)</span>
        <span class="c1"># 2. Generate a Parameter object from the output</span>
        <span class="n">combined_prompt_kwargs</span> <span class="o">=</span> <span class="n">compose_model_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prompt_kwargs</span><span class="p">,</span> <span class="n">prompt_kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_map_func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_data_map_func</span><span class="p">()</span>

        <span class="n">predecessors</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">combined_prompt_kwargs</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">Parameter</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Predecessors: </span><span class="si">{</span><span class="n">predecessors</span><span class="si">}</span><span class="s2"> for generator </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">param_data</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">output</span><span class="o">.</span><span class="n">raw_response</span>
            <span class="k">if</span> <span class="n">output</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">output</span><span class="o">.</span><span class="n">error</span>
            <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">output</span><span class="o">.</span><span class="n">error</span><span class="si">}</span><span class="s2">, raw_response: </span><span class="si">{</span><span class="n">output</span><span class="o">.</span><span class="n">raw_response</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">response</span><span class="p">:</span> <span class="n">Parameter</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">param_data</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;_output&quot;</span><span class="p">,</span>
            <span class="n">role_desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Output from (llm) </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">param_type</span><span class="o">=</span><span class="n">ParameterType</span><span class="o">.</span><span class="n">GENERATOR_OUTPUT</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">set_predecessors</span><span class="p">(</span><span class="n">predecessors</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">trace_forward_pass</span><span class="p">(</span><span class="n">input_args</span><span class="o">=</span><span class="n">input_args</span><span class="p">,</span> <span class="n">full_response</span><span class="o">=</span><span class="n">output</span><span class="p">)</span>
        <span class="c1"># attach the demo to the demo parameter</span>
        <span class="c1"># if self.tracing:</span>
        <span class="n">demo_param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_demo_parameter</span><span class="p">(</span><span class="n">combined_prompt_kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">demo_param</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;ID is required for tracing. Please pass it to your Geneartor call.&quot;</span>
                <span class="p">)</span>
            <span class="n">input_prompt_kwargs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">data</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">Parameter</span><span class="p">)</span> <span class="k">else</span> <span class="n">v</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">prompt_kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>

            <span class="n">demo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_demo_data_instance</span><span class="p">(</span>
                <span class="n">input_prompt_kwargs</span><span class="p">,</span>
                <span class="n">output</span><span class="p">,</span>
                <span class="c1"># self._demo_data_class_output_mapping,</span>
                <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">demo_param</span><span class="o">.</span><span class="n">add_to_trace</span><span class="p">(</span><span class="n">demo</span><span class="p">,</span> <span class="n">is_teacher</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">teacher_mode</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;No demo parameter found in the prompt_kwargs. You can not trace the demo data.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">backward_engine</span><span class="p">:</span>
            <span class="c1"># self.set_backward_engine()</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Backward engine: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">backward_engine</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># attach a funtion to compute gradient for predecessors</span>
        <span class="n">response</span><span class="o">.</span><span class="n">set_grad_fn</span><span class="p">(</span>
            <span class="n">BackwardContext</span><span class="p">(</span>
                <span class="n">backward_fn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">backward</span><span class="p">,</span>
                <span class="n">backward_engine</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">backward_engine</span><span class="p">,</span>
                <span class="n">response</span><span class="o">=</span><span class="n">response</span><span class="p">,</span>
                <span class="n">prompt_kwargs</span><span class="o">=</span><span class="p">{</span>
                    <span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">data</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">Parameter</span><span class="p">)</span> <span class="k">else</span> <span class="n">v</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">prompt_kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="p">},</span>
                <span class="n">template</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">,</span>
                <span class="n">prompt_str</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_prompt</span><span class="p">(</span><span class="o">**</span><span class="n">combined_prompt_kwargs</span><span class="p">),</span>
                <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span></div>


    <span class="c1"># == pytorch custom autograd function ==</span>
<div class="viewcode-block" id="Generator.backward">
<a class="viewcode-back" href="../../apis/core/core.generator.html#core.generator.Generator.backward">[docs]</a>
    <span class="k">def</span> <span class="nf">backward</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">response</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">,</span>  <span class="c1"># the output of the forward pass</span>
        <span class="n">prompt_kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
        <span class="n">template</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">prompt_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">backward_engine</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s2">&quot;Generator&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># the id of the input</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Parameter</span><span class="p">:</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generator: Backward: </span><span class="si">{</span><span class="n">response</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">children_params</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">predecessors</span>
        <span class="n">is_chain</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">get_gradient_and_context_text</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generator: Backward: No gradient found for </span><span class="si">{</span><span class="n">response</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="c1"># backward score to the demo parameter</span>
        <span class="k">for</span> <span class="n">pred</span> <span class="ow">in</span> <span class="n">children_params</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pred</span><span class="o">.</span><span class="n">requires_opt</span><span class="p">:</span>
                <span class="n">pred</span><span class="o">.</span><span class="n">set_score</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">_score</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;backpropagate the score </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">_score</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">pred</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">, is_teacher: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">teacher_mode</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">pred</span><span class="o">.</span><span class="n">param_type</span> <span class="o">==</span> <span class="n">ParameterType</span><span class="o">.</span><span class="n">DEMOS</span><span class="p">:</span>
                    <span class="c1"># Accumulate the score to the demo</span>
                    <span class="n">pred</span><span class="o">.</span><span class="n">add_score_to_trace</span><span class="p">(</span>
                        <span class="n">trace_id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span> <span class="n">score</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">_score</span><span class="p">,</span> <span class="n">is_teacher</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">teacher_mode</span>
                    <span class="p">)</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Pred: </span><span class="si">{</span><span class="n">pred</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">, traces: </span><span class="si">{</span><span class="n">pred</span><span class="o">.</span><span class="n">_traces</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># 1.backward for text-gradients</span>
        <span class="k">if</span> <span class="n">backward_engine</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Generator: Backward engine is set for the generator. </span><span class="si">{</span><span class="n">backward_engine</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">pred</span> <span class="ow">in</span> <span class="n">children_params</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">pred</span><span class="o">.</span><span class="n">requires_opt</span> <span class="ow">or</span> <span class="n">pred</span><span class="o">.</span><span class="n">param_type</span> <span class="o">==</span> <span class="n">ParameterType</span><span class="o">.</span><span class="n">DEMOS</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;EvalFnToTextLoss: Skipping </span><span class="si">{</span><span class="n">pred</span><span class="si">}</span><span class="s2"> as it does not require optimization.&quot;</span>
                    <span class="p">)</span>
                    <span class="k">continue</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_backward_through_one_predecessor</span><span class="p">(</span>
                    <span class="n">pred</span><span class="o">=</span><span class="n">pred</span><span class="p">,</span>
                    <span class="n">response</span><span class="o">=</span><span class="n">response</span><span class="p">,</span>
                    <span class="n">prompt_kwargs</span><span class="o">=</span><span class="n">prompt_kwargs</span><span class="p">,</span>
                    <span class="n">template</span><span class="o">=</span><span class="n">template</span><span class="p">,</span>
                    <span class="n">backward_engine</span><span class="o">=</span><span class="n">backward_engine</span><span class="p">,</span>
                    <span class="n">prompt_str</span><span class="o">=</span><span class="n">prompt_str</span><span class="p">,</span>
                    <span class="n">is_chain</span><span class="o">=</span><span class="n">is_chain</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Backward engine is not set for the generator. No text gradient.&quot;</span><span class="p">)</span></div>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_backward_through_one_predecessor</span><span class="p">(</span>
        <span class="n">pred</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">,</span>
        <span class="n">response</span><span class="p">:</span> <span class="n">Parameter</span><span class="p">,</span>
        <span class="n">prompt_kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
        <span class="n">template</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">backward_engine</span><span class="p">:</span> <span class="s2">&quot;BackwardEngine&quot;</span><span class="p">,</span>
        <span class="n">prompt_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">is_chain</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pred</span><span class="o">.</span><span class="n">requires_opt</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Generator: Skipping </span><span class="si">{</span><span class="n">pred</span><span class="si">}</span><span class="s2"> as it does not require optimization.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generator: Backward through </span><span class="si">{</span><span class="n">pred</span><span class="si">}</span><span class="s2">, is_chain: </span><span class="si">{</span><span class="n">is_chain</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pred</span><span class="o">.</span><span class="n">check_if_already_computed_gradient_respect_to</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">id</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Generator: Skipping </span><span class="si">{</span><span class="n">pred</span><span class="si">}</span><span class="s2"> as the gradient is already computed.&quot;</span>
            <span class="p">)</span>

            <span class="k">return</span>

        <span class="n">instruction_str</span><span class="p">,</span> <span class="n">objective_str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="c1"># 1. Generate the conversation string</span>

        <span class="n">input_prompt_kwargs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">data</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">Parameter</span><span class="p">)</span> <span class="k">else</span> <span class="n">v</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">prompt_kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="n">conversation_prompt_kwargs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;variable_name&quot;</span><span class="p">:</span> <span class="n">pred</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s2">&quot;input_value&quot;</span><span class="p">:</span> <span class="n">input_prompt_kwargs</span><span class="p">,</span>
            <span class="s2">&quot;llm_output&quot;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">conversation_str</span> <span class="o">=</span> <span class="n">Prompt</span><span class="p">(</span>
            <span class="n">prompt_kwargs</span><span class="o">=</span><span class="n">conversation_prompt_kwargs</span><span class="p">,</span>
            <span class="n">template</span><span class="o">=</span><span class="n">LLM_CONVERSATION_TEMPLATE</span><span class="p">,</span>
        <span class="p">)()</span>

        <span class="n">variable_dict</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">get_param_info</span><span class="p">()</span>

        <span class="n">variable_and_peers_info</span> <span class="o">=</span> <span class="n">Prompt</span><span class="p">(</span>
            <span class="n">prompt_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;variable&quot;</span><span class="p">:</span> <span class="n">variable_dict</span><span class="p">,</span> <span class="s2">&quot;peers&quot;</span><span class="p">:</span> <span class="n">pred</span><span class="o">.</span><span class="n">peers</span><span class="p">},</span>
            <span class="n">template</span><span class="o">=</span><span class="n">VARIABLE_AND_PEERS_INFO</span><span class="p">,</span>
        <span class="p">)()</span>

        <span class="n">conv_ins_template</span> <span class="o">=</span> <span class="n">CONVERSATION_START_INSTRUCTION_BASE</span>
        <span class="n">obj_ins_template</span> <span class="o">=</span> <span class="n">OBJECTIVE_INSTRUCTION_BASE</span>
        <span class="k">if</span> <span class="n">is_chain</span><span class="p">:</span>
            <span class="n">conv_ins_template</span> <span class="o">=</span> <span class="n">CONVERSATION_START_INSTRUCTION_CHAIN</span>
            <span class="n">obj_ins_template</span> <span class="o">=</span> <span class="n">OBJECTIVE_INSTRUCTION_CHAIN</span>

        <span class="n">instruction_str</span> <span class="o">=</span> <span class="n">Prompt</span><span class="p">(</span>
            <span class="n">template</span><span class="o">=</span><span class="n">conv_ins_template</span><span class="p">,</span>
            <span class="n">prompt_kwargs</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;variable_and_peers_info&quot;</span><span class="p">:</span> <span class="n">variable_and_peers_info</span><span class="p">,</span>
                <span class="s2">&quot;conversation_str&quot;</span><span class="p">:</span> <span class="n">conversation_str</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Conversation start instruction base str: </span><span class="si">{</span><span class="n">instruction_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">objective_str</span> <span class="o">=</span> <span class="n">Prompt</span><span class="p">(</span>
            <span class="n">template</span><span class="o">=</span><span class="n">obj_ins_template</span><span class="p">,</span>
            <span class="n">prompt_kwargs</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;response_desc&quot;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">role_desc</span><span class="p">,</span>
                <span class="s2">&quot;response_gradient&quot;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">get_gradient_and_context_text</span><span class="p">(),</span>
                <span class="s2">&quot;instruction_to_backward_engine&quot;</span><span class="p">:</span> <span class="n">pred</span><span class="o">.</span><span class="n">instruction_to_backward_engine</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)()</span>

        <span class="n">backward_engine_prompt_kwargs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;conversation_sec&quot;</span><span class="p">:</span> <span class="n">instruction_str</span><span class="p">,</span>
            <span class="s2">&quot;objective_instruction_sec&quot;</span><span class="p">:</span> <span class="n">objective_str</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">gradient_output</span><span class="p">:</span> <span class="n">GeneratorOutput</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">_score</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">float</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">_score</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.9</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;EvalFnToTextLoss: Skipping </span><span class="si">{</span><span class="n">pred</span><span class="si">}</span><span class="s2"> as the score is high enough.&quot;</span><span class="p">)</span>
            <span class="n">manual_response</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;You get a high score: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">_score</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="n">gradient_output</span> <span class="o">=</span> <span class="n">GeneratorOutput</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="n">manual_response</span><span class="p">,</span> <span class="n">raw_response</span><span class="o">=</span><span class="n">manual_response</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="n">gradient_output</span><span class="p">:</span> <span class="n">GeneratorOutput</span> <span class="o">=</span> <span class="n">backward_engine</span><span class="p">(</span>
                <span class="n">prompt_kwargs</span><span class="o">=</span><span class="n">backward_engine_prompt_kwargs</span>
            <span class="p">)</span>
        <span class="c1"># USE this to trace each node&#39;s input and output, all nodes can be visualized</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Generator Backward Engine Prompt: </span><span class="si">{</span><span class="n">backward_engine</span><span class="o">.</span><span class="n">get_prompt</span><span class="p">(</span><span class="w"> </span><span class="o">**</span><span class="n">backward_engine_prompt_kwargs</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">gradient_value</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">gradient_output</span><span class="o">.</span><span class="n">data</span>
            <span class="ow">or</span> <span class="n">backward_engine</span><span class="o">.</span><span class="n">failure_message_to_optimizer</span><span class="p">(</span><span class="n">gradient_output</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Generator Gradient value: </span><span class="si">{</span><span class="n">gradient_value</span><span class="si">}</span><span class="s2">, raw response: </span><span class="si">{</span><span class="n">gradient_output</span><span class="o">.</span><span class="n">raw_response</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="c1"># TODO: make it a debug feature</span>
        <span class="c1"># prompt_str = backward_engine.get_prompt(**backward_engine_prompt_kwargs)</span>
        <span class="n">var_gradient</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_to_</span><span class="si">{</span><span class="n">pred</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_grad&quot;</span><span class="p">,</span>
            <span class="c1"># gradient_prompt=prompt_str,  # trace the prompt</span>
            <span class="n">data</span><span class="o">=</span><span class="n">gradient_value</span><span class="p">,</span>
            <span class="n">requires_opt</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">role_desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;feedback for </span><span class="si">{</span><span class="n">pred</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">score</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">_score</span><span class="p">,</span>  <span class="c1"># add score to gradient</span>
            <span class="n">param_type</span><span class="o">=</span><span class="n">ParameterType</span><span class="o">.</span><span class="n">GRADIENT</span><span class="p">,</span>
            <span class="n">from_response_id</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">pred</span><span class="o">.</span><span class="n">add_gradient</span><span class="p">(</span><span class="n">var_gradient</span><span class="p">)</span>
        <span class="n">pred</span><span class="o">.</span><span class="n">set_score</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">_score</span><span class="p">)</span>

        <span class="n">pred</span><span class="o">.</span><span class="n">gradients_context</span><span class="p">[</span><span class="n">var_gradient</span><span class="p">]</span> <span class="o">=</span> <span class="n">GradientContext</span><span class="p">(</span>
            <span class="n">context</span><span class="o">=</span><span class="n">conversation_str</span><span class="p">,</span>
            <span class="n">response_desc</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">role_desc</span><span class="p">,</span>
            <span class="n">variable_desc</span><span class="o">=</span><span class="n">pred</span><span class="o">.</span><span class="n">role_desc</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_run_callbacks</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">output</span><span class="p">:</span> <span class="n">GeneratorOutput</span><span class="p">,</span>
        <span class="nb">input</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
        <span class="n">prompt_kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
        <span class="n">model_kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger_callbacks</span><span class="p">(</span>
            <span class="s2">&quot;on_complete&quot;</span><span class="p">,</span>
            <span class="n">output</span><span class="o">=</span><span class="n">output</span><span class="p">,</span>
            <span class="nb">input</span><span class="o">=</span><span class="nb">input</span><span class="p">,</span>
            <span class="n">prompt_kwargs</span><span class="o">=</span><span class="n">prompt_kwargs</span><span class="p">,</span>
            <span class="n">model_kwargs</span><span class="o">=</span><span class="n">model_kwargs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">output</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;call back on failure: </span><span class="si">{</span><span class="n">output</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trigger_callbacks</span><span class="p">(</span>
                <span class="s2">&quot;on_failure&quot;</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="n">output</span><span class="p">,</span>
                <span class="nb">input</span><span class="o">=</span><span class="nb">input</span><span class="p">,</span>
                <span class="n">prompt_kwargs</span><span class="o">=</span><span class="n">prompt_kwargs</span><span class="p">,</span>
                <span class="n">model_kwargs</span><span class="o">=</span><span class="n">model_kwargs</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trigger_callbacks</span><span class="p">(</span>
                <span class="s2">&quot;on_success&quot;</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="n">output</span><span class="p">,</span>
                <span class="nb">input</span><span class="o">=</span><span class="nb">input</span><span class="p">,</span>
                <span class="n">prompt_kwargs</span><span class="o">=</span><span class="n">prompt_kwargs</span><span class="p">,</span>
                <span class="n">model_kwargs</span><span class="o">=</span><span class="n">model_kwargs</span><span class="p">,</span>
            <span class="p">)</span>

<div class="viewcode-block" id="Generator.call">
<a class="viewcode-back" href="../../apis/core/core.generator.html#core.generator.Generator.call">[docs]</a>
    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">prompt_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span>  <span class="c1"># the input need to be passed to the prompt</span>
        <span class="n">model_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span>
        <span class="n">use_cache</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GeneratorOutputType</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Call the model_client by formatting prompt from the prompt_kwargs,</span>
<span class="sd">        and passing the combined model_kwargs to the model client.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mock_output</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">GeneratorOutput</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mock_output_data</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>

        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;prompt_kwargs: </span><span class="si">{</span><span class="n">prompt_kwargs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;model_kwargs: </span><span class="si">{</span><span class="n">model_kwargs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">api_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pre_call</span><span class="p">(</span><span class="n">prompt_kwargs</span><span class="p">,</span> <span class="n">model_kwargs</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;api_kwargs: </span><span class="si">{</span><span class="n">api_kwargs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output</span><span class="p">:</span> <span class="n">GeneratorOutputType</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># call the model client</span>

        <span class="n">completion</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">use_cache</span> <span class="o">=</span> <span class="n">use_cache</span> <span class="k">if</span> <span class="n">use_cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_cache</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">completion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_client_call</span><span class="p">(</span>
                <span class="n">api_kwargs</span><span class="o">=</span><span class="n">api_kwargs</span><span class="p">,</span> <span class="n">use_cache</span><span class="o">=</span><span class="n">use_cache</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error calling the model: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">GeneratorOutput</span><span class="p">(</span><span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>
        <span class="c1"># process the completion</span>
        <span class="k">if</span> <span class="n">completion</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_post_call</span><span class="p">(</span><span class="n">completion</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing the output: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">GeneratorOutput</span><span class="p">(</span>
                    <span class="n">raw_response</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">completion</span><span class="p">),</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="nb">id</span><span class="o">=</span><span class="nb">id</span>
                <span class="p">)</span>

        <span class="c1"># User only need to use one of them, no need to use them all.</span>
        <span class="n">output</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_callbacks</span><span class="p">(</span>
            <span class="n">output</span><span class="p">,</span>
            <span class="nb">input</span><span class="o">=</span><span class="n">api_kwargs</span><span class="p">,</span>
            <span class="n">prompt_kwargs</span><span class="o">=</span><span class="n">prompt_kwargs</span><span class="p">,</span>
            <span class="n">model_kwargs</span><span class="o">=</span><span class="n">model_kwargs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;output: </span><span class="si">{</span><span class="n">output</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span></div>


    <span class="c1"># TODO: training is not supported in async call yet</span>
<div class="viewcode-block" id="Generator.acall">
<a class="viewcode-back" href="../../apis/core/core.generator.html#core.generator.Generator.acall">[docs]</a>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">acall</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">prompt_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span>
        <span class="n">model_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span>
        <span class="n">use_cache</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GeneratorOutputType</span><span class="p">:</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Async call the model with the input and model_kwargs.</span>

<span class="sd">        :warning::</span>
<span class="sd">            Training is not supported in async call yet.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;prompt_kwargs: </span><span class="si">{</span><span class="n">prompt_kwargs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;model_kwargs: </span><span class="si">{</span><span class="n">model_kwargs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">api_kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pre_call</span><span class="p">(</span><span class="n">prompt_kwargs</span><span class="p">,</span> <span class="n">model_kwargs</span><span class="p">)</span>
        <span class="n">output</span><span class="p">:</span> <span class="n">GeneratorOutputType</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># call the model client</span>
        <span class="n">completion</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">completion</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_client</span><span class="o">.</span><span class="n">acall</span><span class="p">(</span>
                <span class="n">api_kwargs</span><span class="o">=</span><span class="n">api_kwargs</span><span class="p">,</span> <span class="n">model_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_type</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error calling the model: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">GeneratorOutput</span><span class="p">(</span><span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">completion</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_post_call</span><span class="p">(</span><span class="n">completion</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing the output: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">GeneratorOutput</span><span class="p">(</span><span class="n">raw_response</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">completion</span><span class="p">),</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;output: </span><span class="si">{</span><span class="n">output</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_callbacks</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="n">api_kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span></div>


    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">GeneratorOutputType</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">training</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Training mode&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Inference mode&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_extra_repr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;model_kwargs=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_kwargs</span><span class="si">}</span><span class="s2">, &quot;</span>
        <span class="k">return</span> <span class="n">s</span>

<div class="viewcode-block" id="Generator.failure_message_to_backward_engine">
<a class="viewcode-back" href="../../apis/core/core.generator.html#core.generator.Generator.failure_message_to_backward_engine">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">failure_message_to_backward_engine</span><span class="p">(</span>
        <span class="n">gradient_response</span><span class="p">:</span> <span class="n">GeneratorOutput</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">response_value</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">gradient_response</span><span class="o">.</span><span class="n">error</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">gradient_response</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="n">response_value</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">gradient_response</span><span class="o">.</span><span class="n">error</span><span class="si">}</span><span class="s2">, Raw response: </span><span class="si">{</span><span class="n">gradient_response</span><span class="o">.</span><span class="n">raw_response</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">response_value</span></div>
</div>



<div class="viewcode-block" id="BackwardEngine">
<a class="viewcode-back" href="../../apis/core/core.generator.html#core.generator.BackwardEngine">[docs]</a>
<span class="k">class</span> <span class="nc">BackwardEngine</span><span class="p">(</span><span class="n">Generator</span><span class="p">):</span>  <span class="c1"># it is a generator with defaule template</span>

    <span class="vm">__doc__</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;The backward engine is a Generator with a default template for the backward pass.</span>

<span class="s2">    If you want to customize the template, you can create your own backward engine&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;template&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">FEEDBACK_ENGINE_TEMPLATE</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="BackwardEngine.failure_message_to_optimizer">
<a class="viewcode-back" href="../../apis/core/core.generator.html#core.generator.BackwardEngine.failure_message_to_optimizer">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">failure_message_to_optimizer</span><span class="p">(</span>
        <span class="n">gradient_response</span><span class="p">:</span> <span class="n">GeneratorOutput</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">gradient_value_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">gradient_response</span><span class="o">.</span><span class="n">error</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">gradient_response</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="n">gradient_value_data</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;The backward engine failed to compute the gradient. Raw response: </span><span class="si">{</span><span class="n">gradient_response</span><span class="o">.</span><span class="n">raw_response</span><span class="si">}</span><span class="s2">, Error: </span><span class="si">{</span><span class="n">gradient_response</span><span class="o">.</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">return</span> <span class="n">gradient_value_data</span></div>
</div>



<div class="viewcode-block" id="create_teacher_generator">
<a class="viewcode-back" href="../../apis/core/core.generator.html#core.generator.create_teacher_generator">[docs]</a>
<span class="k">def</span> <span class="nf">create_teacher_generator</span><span class="p">(</span>
    <span class="n">student</span><span class="p">:</span> <span class="n">Generator</span><span class="p">,</span>
    <span class="n">model_client</span><span class="p">:</span> <span class="n">ModelClient</span><span class="p">,</span>
    <span class="n">model_kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">template</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Create a teacher generator from the student generator.</span>

<span class="sd">    Note:</span>
<span class="sd">        Teacher generator will have no parameters.</span>
<span class="sd">        If you want to keep it to be the same as the student, just create one each time your student has been updated.</span>
<span class="sd">        Or else, task.parameters will list teacher parameters.</span>

<span class="sd">    Args:</span>
<span class="sd">        student (Generator): The student generator.</span>
<span class="sd">        model_client (ModelClient): The model client to use for the teacher generator.</span>
<span class="sd">        model_kwargs (Dict[str, Any]): The model kwargs to pass to the model client.</span>
<span class="sd">        name (str, optional): The name of the teacher generator. Defaults to &quot;teacher&quot;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Generator: The teacher generator.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">student</span><span class="o">.</span><span class="n">_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;model_client&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_client</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;model_kwargs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_kwargs</span>
    <span class="k">if</span> <span class="n">template</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;template&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">template</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">student</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_teacher&quot;</span>

    <span class="n">prompt_kwargs_str</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;prompt_kwargs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">Parameter</span><span class="p">):</span>
            <span class="n">prompt_kwargs_str</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prompt_kwargs_str</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;prompt_kwargs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prompt_kwargs_str</span>
    <span class="n">teacher</span> <span class="o">=</span> <span class="n">Generator</span><span class="p">(</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">teacher</span></div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c1"># test the generator with backward engine</span>
    <span class="c1"># TODO: move this to external local tests before packaging</span>
    <span class="kn">from</span> <span class="nn">adalflow.components.model_client</span> <span class="kn">import</span> <span class="p">(</span>
        <span class="n">GroqAPIClient</span><span class="p">,</span>
        <span class="n">OpenAIClient</span><span class="p">,</span>
        <span class="n">GoogleGenAIClient</span><span class="p">,</span>
        <span class="n">AnthropicAPIClient</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="kn">from</span> <span class="nn">adalflow.utils</span> <span class="kn">import</span> <span class="n">setup_env</span>
    <span class="kn">from</span> <span class="nn">adalflow.core.model_client</span> <span class="kn">import</span> <span class="n">ModelClient</span>

    <span class="n">setup_env</span><span class="p">()</span>
    <span class="c1"># log = get_logger(level=&quot;DEBUG&quot;)</span>
    <span class="n">llama3_model</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;model_client&quot;</span><span class="p">:</span> <span class="n">GroqAPIClient</span><span class="p">(),</span>
        <span class="s2">&quot;model_kwargs&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;llama-3.1-8b-instant&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>
    <span class="n">gpt_3_model</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;model_client&quot;</span><span class="p">:</span> <span class="n">OpenAIClient</span><span class="p">(),</span>
        <span class="s2">&quot;model_kwargs&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;gpt-3.5-turbo&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>
    <span class="n">gemini_model</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;model_client&quot;</span><span class="p">:</span> <span class="n">GoogleGenAIClient</span><span class="p">(),</span>
        <span class="s2">&quot;model_kwargs&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;gemini-1.0-pro&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>
    <span class="n">claude_model</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;model_client&quot;</span><span class="p">:</span> <span class="n">AnthropicAPIClient</span><span class="p">(),</span>
        <span class="s2">&quot;model_kwargs&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;claude-3-opus-20240229&quot;</span><span class="p">,</span>
            <span class="s2">&quot;max_tokens&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>
    <span class="kn">from</span> <span class="nn">adalflow.tracing.generator_call_logger</span> <span class="kn">import</span> <span class="n">GeneratorCallLogger</span>
    <span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>

    <span class="c1"># setup the logger</span>
    <span class="n">call_logger</span> <span class="o">=</span> <span class="n">GeneratorCallLogger</span><span class="p">(</span><span class="n">save_dir</span><span class="o">=</span><span class="s2">&quot;traces&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">on_complete</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">prompt_kwargs</span><span class="p">,</span> <span class="n">model_kwargs</span><span class="p">,</span> <span class="n">logger_call</span><span class="p">:</span> <span class="n">Callable</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;on_complet  output: </span><span class="si">{</span><span class="n">output</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger_call</span><span class="p">(</span>
            <span class="n">output</span><span class="o">=</span><span class="n">output</span><span class="p">,</span>
            <span class="nb">input</span><span class="o">=</span><span class="nb">input</span><span class="p">,</span>
            <span class="n">prompt_kwargs</span><span class="o">=</span><span class="n">prompt_kwargs</span><span class="p">,</span>
            <span class="n">model_kwargs</span><span class="o">=</span><span class="n">model_kwargs</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="p">[</span><span class="n">llama3_model</span><span class="p">,</span> <span class="n">gpt_3_model</span><span class="p">,</span> <span class="n">gemini_model</span><span class="p">,</span> <span class="n">claude_model</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&quot;&quot;model: </span><span class="si">{</span><span class="n">model</span><span class="p">[</span><span class="s2">&quot;model_kwargs&quot;</span><span class="p">][</span><span class="s2">&quot;model&quot;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">generator</span> <span class="o">=</span> <span class="n">Generator</span><span class="p">(</span><span class="o">**</span><span class="n">model</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;_kwargs: &quot;</span><span class="p">,</span> <span class="n">generator</span><span class="o">.</span><span class="n">_kwargs</span><span class="p">)</span>

        <span class="n">teacher</span> <span class="o">=</span> <span class="n">create_teacher_generator</span><span class="p">(</span><span class="n">generator</span><span class="p">,</span> <span class="o">**</span><span class="n">claude_model</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;teacher: </span><span class="si">{</span><span class="n">teacher</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">call_logger</span><span class="o">.</span><span class="n">register_generator</span><span class="p">(</span><span class="s2">&quot;generator&quot;</span><span class="p">,</span> <span class="s2">&quot;generator_call&quot;</span><span class="p">)</span>
        <span class="c1"># setup the callback</span>
        <span class="n">logger_call</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">call_logger</span><span class="o">.</span><span class="n">log_call</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;generator&quot;</span><span class="p">)</span>
        <span class="n">generator</span><span class="o">.</span><span class="n">register_callback</span><span class="p">(</span>
            <span class="s2">&quot;on_complete&quot;</span><span class="p">,</span> <span class="n">partial</span><span class="p">(</span><span class="n">on_complete</span><span class="p">,</span> <span class="n">logger_call</span><span class="o">=</span><span class="n">logger_call</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">output</span> <span class="o">=</span> <span class="n">generator</span><span class="p">(</span>
            <span class="n">prompt_kwargs</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;input_str&quot;</span><span class="p">:</span> <span class="s2">&quot;Hello, world!&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;output: </span><span class="si">{</span><span class="n">output</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">break</span>

    <span class="c1"># test the backward engine</span>
    <span class="c1"># TODO: test ollama and transformer client to update the change</span>
</pre></div>

                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
       Copyright 2024, SylphAI, Inc.
      <br/>
    
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.15.4.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>